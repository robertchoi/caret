# 🛠️ Caret Developer Guide

Detailed information related to the development of the Caret project, such as building, testing, and packaging.

## Build and Packaging 🛠️

Follow these steps to set up your local development environment and build the extension.

### 1. Repository Setup

Caret adopts a **Fork-based architecture** from the [Cline](https://github.com/cline/cline) project. It directly includes Cline's stable codebase in the `src/` directory, while developing Caret's unique extension features in `caret-src/`.

1.  **Clone Caret Repository**:
    ```bash
    git clone https://github.com/aicoding-caret/caret.git
    cd caret
    ```

2.  **Understand Architecture Structure**:
    ```
    caret/
    ├── src/                    # Cline Original Code (Preserved)
    │   ├── extension.ts        # Cline Main Entry Point
    │   └── core/              # Cline Core Logic
    ├── caret-src/             # Caret Extension Features
    │   ├── extension.ts       # Caret Entry Point (utilizes src/ modules)
    │   └── core/webview/      # Caret Exclusive WebView Provider
    ├── caret-assets/          # Caret Asset Management
    │   ├── template_characters/ # AI Character Templates
    │   ├── rules/             # Default Mode and Rule Definitions
    │   └── icons/             # Project Icons
    ├── caret-docs/            # Caret Exclusive Documentation
    └── webview-ui/            # Frontend (utilizes Cline build system)
        ├── src/components/    # Cline Original Components
        └── src/caret/         # Caret Exclusive Components
    ```
    
    This structure allows you to **leverage Cline's powerful features as is**, while **safely extending Caret's unique functionalities**.

### 2. Install Dependencies

How to install all dependencies for the Caret project.

```bash
# Recommended for all platforms - installs root and webview-ui dependencies at once
npm run install:all
```

This command performs the following tasks:
- Installs root project dependencies (`npm install`)
- Installs webview-ui directory dependencies (`cd webview-ui && npm install`)

> **Note**: `npm run install:all` is a **dependency installation only** command. It is separate from building the VSIX file.

### 3. Manual Setup (If Issues Occur)

If the automatic setup script fails or you want to run specific steps manually, follow the manual procedure below.

```bash
# 1. Install Dependencies
npm install
cd webview-ui && npm install && cd ..

# 2. Compile Protocol Buffer
npm run protos

# 3. Verify TypeScript Compilation
npm run compile
```

### 4. Development Build

Compiles the extension's TypeScript code:

```bash
# Compile Protocol Buffer (if needed)
npm run protos

# Compile TypeScript
npm run compile
```

### 5. Run in Development Environment

Press `F5` in VS Code to start a debugging session, and you can test the extension in a new `[Extension Development Host]` window.

**How to Run Caret:**
- Once the extension is running, a **Caret icon** will be added to the **Primary Sidebar** in VS Code.
- Click this icon to open the Caret webview and start using it.

**Development Mode Features:**
- **Hot Reload**: Automatic compilation on code changes with `npm run watch`
- **Debugging**: Backend code debugging support via VS Code debugger
- **Integrated Logging**: Optimized log output with automatic dev/prod mode detection (Dev: DEBUG+console, Prod: INFO+VSCode only)

### 6. VSIX Release Packaging 🎯

Packages the developed extension into a `.vsix` file for local installation or distribution.
**All build artifacts are generated in the `output/` directory in the format `caret-{version}-{datetime}.vsix`.**

#### 6-1. JavaScript Script Method (✅ Recommended - All Environments)

```bash
# Run from project root
npm run package:release
```

**File generated by this command**: `output/caret-0.1.0-202501271545.vsix`

This command automatically performs the following tasks:
- ✅ Reads version information from `package.json`
- ✅ Generates timestamp (YYYYMMDDHHMM format)
- ✅ Creates `output/` directory (if it doesn't exist)
- ✅ Cleans up previous builds (`webview-ui/build/`, `dist/`)
- ✅ Performs full clean build (`npm run protos`, `npm run compile`, `npm run build:webview`)
- ✅ Packages VSIX (`vsce package --out output/caret-{version}-{timestamp}.vsix`)
- ✅ Analyzes package size and warns (300MB/750MB thresholds)


#### 🚀 Verify Build Results

Both methods produce the same results:
- **Location**: `output/caret-{version}-{datetime}.vsix`
- **Example**: `output/caret-0.1.0-202501271545.vsix`
- **Installation**: `code --install-extension output/caret-0.1.0-202501271545.vsix`

## 🧪 Testing and Quality Management

Caret adopts the **TDD (Test-Driven Development) methodology** to maintain high code quality.

### 📊 Run All Tests + Coverage

```bash
# 🌟 Recommended: Full test + coverage analysis (at once)
npm run test:all; npm run caret:coverage

# Or including backend detailed coverage
npm run test:all; npm run test:backend:coverage; npm run caret:coverage
```

### 🎯 Run Individual Tests

**⚠️ Important: Correct Test Command Usage**

**❌ Caution: Do NOT use `npm test`**
- `npm test` runs full build + compile + lint + all tests, which is very slow
- During development, it is recommended to use the **individual test commands** below

**✅ Recommended test commands during development:**

```bash
# Backend individual test (specific file)
npm run test:backend caret-src/__tests__/your-test-file.test.ts

# Backend individual test (specific test name)
npm run test:backend caret-src/__tests__/your-test-file.test.ts -t "your test name"

# Frontend test
npm run test:webview

# Backend watch mode (auto-run during development)
npm run test:backend:watch

# Fast development test (excluding webview, stops immediately on failure)
npm run dev:build-test:fast
```

**📊 Full Test + Coverage (for CI/CD or final verification):**

```bash
# Full test + coverage analysis
npm run test:all && npm run caret:coverage

# Integration test (VSCode Extension Environment)
npm run test:integration
```

### 📈 Coverage Analysis

```bash
# Caret-specific code coverage analysis (detailed by file)
npm run caret:coverage

# Backend Vitest coverage (detailed by line)
npm run test:backend:coverage

# VSCode Extension integration coverage
npm run test:coverage
```

### 🎯 Check Test Status

Running the above commands allows you to check the current project's test pass rate and coverage in real-time.

### 📋 TDD Principles and Coverage Goals

The Caret project adheres to the following TDD principles:

1. **🔴 RED**: Write failing tests first
2. **🟢 GREEN**: Write minimal code that passes the tests
3. **🔄 REFACTOR**: Improve code quality

#### 🎯 Coverage Goals and Reality

- **🥕 Caret New Logic**: **100% coverage required** - all new features and business logic are test-first developed
- **🔗 Existing Re-export**: Some files are simple re-exports of Cline modules and do not require separate testing
- **📦 Type Definitions**: Files containing only interface definitions have no runtime logic and can be excluded from testing

**When developing new features, you must write tests first!**

For detailed testing guidelines, please refer to the **[Testing Guide](./caret-docs/development/testing-guide.mdx)**.

## 🔬 Patented Technology

### Core Technology
Caret's **modular system prompt architecture** is implemented based on CARETIVE INC's patent-pending technology ("Method and System for Optimizing Prompt Information").

**Key Features:**
- **Dual Representation**: Markdown-JSON structure optimized for both humans and AI
- **Modular Structure**: Decomposes hardcoded prompts into JSON modules for management
- **Token Optimization**: Reduces API costs by identifying redundant elements
- **Automated Verification**: Safety system ensuring functionality preservation

### License
- **Open Source**: Apache 2.0 license allows free use, modification, and distribution
- **Patent Protection**: Intellectual property rights for core technology held by CARETIVE INC
- **Commercial Use**: For patent-related inquiries, contact **support@caretive.ai**

## 📊 Telemetry (PostHog) Setup

Caret Community/Dev builds and Release builds have **telemetry activation** completely separated.

| Build Type | Environment Variable | Result |
|-----------|-----------|-------|
| dev / community | _(Not set)_ | PostHog **disabled** (0 events) |
| release (enterprise) | `POSTHOG_API_KEY`, `POSTHOG_HOST`, `POSTHOG_UIHOST` | PostHog **enabled** – sent to `posthog.caret.team` |

Build Example:

```bash
# 🚧 Community/dev (VSCode F5)
npm run watch            # No telemetry

# 🚀 Release / CI
export BUILD_FLAVOR=enterprise
export POSTHOG_API_KEY=phc_xxx            # Issued from PostHog UI
export POSTHOG_HOST="https://posthog.caret.team"
export POSTHOG_UIHOST="https://posthog.caret.team"

npm run package:release   # output/caret-<ver>-<ts>.vsix
```

> If environment variables are not set, `PostHogClientProvider` automatically falls back to a dummy client.
