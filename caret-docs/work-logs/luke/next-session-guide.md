# Next Session Guide (Luke) - 2025.01.21

## 🚨 긴급 이슈: 페르소나 이미지 업로드 시스템 완전 분석 및 수정 필요

### 마스터 테스트 결과 분석 (2025.01.21)

#### 1. **파일 업로드 반영 실패**
- **문제**: 두 이미지 모두 업로드했으나 채팅창과 페르소나에 반영되지 않음
- **추정 원인**: 업로드된 파일이 기본 이미지(`caret-assets/agent_profile.png`)를 덮지 않고 **다른 위치에 저장**되고 있음

#### 2. **페르소나 템플릿 자동 덮어씌우기 문제**
- **문제**: 기본 이미지에서 선택된 페르소나 템플릿으로 자동 덮기 기능이 작동

#### 3. **채팅창 이미지 미반영**
- **문제**: 업로드 이미지, 페르소나 이미지 모두 채팅창에 적용되지 않음
- **추정 원인**: `caret-assets/agent_profile.png`의 에셋 리소스를 직접 참조하고 있음

#### 4. **🎯 근본 원인 (마스터 총평)**
- **핵심 문제**: `caret-assets/agent_profile.png`와 `caret-assets/agent_thinking.png`는 원래 **참고/테스트용** 이미지
- **시스템 문제**: 기본 이미지 위치와 업로드 저장 위치가 **분리**되어 있다고 판단됨
- **결과**: 업로드해도 실제 표시되는 이미지가 바뀌지 않는 근본적 설계 오류

---

## 🔧 다음 세션 작업 계획

### Phase 1: 문제 근본 분석
1. **업로드 함수 추적**:
   - `uploadCustomPersonaImage` 함수에서 실제 저장 위치 확인
   - `agent_profile.png` 덮어쓰기 여부 검증

2. **이미지 참조 경로 추적**:
   - PersonaAvatar 컴포넌트에서 실제 참조하는 이미지 경로
   - ChatRow에서 사용하는 이미지 소스 확인

3. **페르소나 템플릿 자동 덮기 로직 분석**:
   - `UPDATE_PERSONA_CUSTOM_INSTRUCTION` 핸들러 수정 사항 검토
   - 자동 이미지 복사 덮어쓰기 로직 확인 및 구현 필요

### Phase 2: 시스템 아키텍처 단순화
1. **단일 경로 시스템 구축**:
   - 업로드 → `caret-assets/agent_profile.png` 직접 덮어쓰기
   - 모든 컴포넌트가 동일한 파일 참조하도록 통일

2. **불필요한 기능 제거**:
   - 페르소나 템플릿 선택 시 자동 이미지 덮기 기능 완전 제거
   - 복잡한 다중 경로 시스템 단순화

### Phase 3: 검증 및 테스트
1. **실제 파일 시스템 테스트**:
   - 업로드 → 실제 파일 저장 → UI 반영 전체 플로우 검증
   - Mock 없이 실제 환경에서 테스트

---

## 🎯 마스터 요구사항 재확인

1. **페르소나 설정에서는 기본 이미지만 표시**
2. **업로드 시 저장되는 이미지가 기본 이미지를 덮어야 함**
3. **페르소나 설정 시 기본 이미지가 선택된 템플릿으로 복사되어야 함**

**현재 상황**: 1, 2, 3 모두 작동하지 않음

---

## 📝 세션 시작 시 체크리스트

- [ ] `caret-src/utils/simple-persona-image.ts`의 `uploadCustomPersonaImage` 실제 저장 위치 확인
- [ ] `caret-assets/agent_profile.png` 파일이 업로드 후 실제로 변경되는지 확인
- [ ] PersonaAvatar 컴포넌트의 이미지 로드 소스 경로 추적
- [ ] 페르소나 템플릿 선택 시 자동 이미지 복사 로직 제거
- [ ] 전체 이미지 플로우 단순화 설계

**마스터 메시지**: "하.. 진짜. 이 간단한걸 이렇게 또 못하고 복잡하게 해놓다니.. 내일 내가 코드 직접봐야겠다."

---

*Updated: 2025.01.21 - 페르소나 이미지 업로드 시스템 문제 분석 완료*