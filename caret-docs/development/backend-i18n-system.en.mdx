# Caret Backend Internationalization System

## Overview

This document describes a simple template-based internationalization system used in the Caret backend. It translates system messages generated in the backend into the appropriate language according to the user's language settings.

## Structure

### 1. Backend i18n Utility
- **Location**: `caret-src/utils/backend-i18n.ts`
- **Functionality**: Template-based message translation and parameter substitution

### 2. Key Function

#### `backendT(key: string, chatSettings: ChatSettings, params?: Record<string, string>): string`

```typescript
import { backendT } from "../../../caret-src/utils/backend-i18n"

const errorMessage = backendT("task.retryWithoutParam", this.chatSettings, {
    toolName: "readFile",
    pathInfo: " for '/path/to/file'",
    paramName: "content"
})
```

**Parameters:**
- `key`: Translation key (e.g., "task.retryWithoutParam")
- `chatSettings`: Current chat settings (including language information)
- `params`: Parameter object for template substitution (optional)

## Supported Languages

- **English (en)**: Default language
- **Korean (ko)**: Korean
- **Japanese (ja)**: Japanese
- **Chinese (zh)**: Chinese

## Message Definitions

### Currently Supported Messages

#### `task.retryWithoutParam`
Error message displayed when a required parameter is missing during tool use.

**Template Variables:**
- `{toolName}`: Name of the tool attempted to use
- `{pathInfo}`: Path information (if available)
- `{paramName}`: Name of the missing parameter

**Translation Example:**
```typescript
{
    "task.retryWithoutParam": {
        en: "Cline tried to use {toolName}{pathInfo} without value for required parameter '{paramName}'. Retrying...",
        ko: "Cline이 {toolName}{pathInfo}을(를) 필수 매개변수 '{paramName}' 값 없이 사용하려고 했습니다. 재시도 중...",
        ja: "Clineが{toolName}{pathInfo}を必須パラメータ'{paramName}'の値なしで使用しようとしました。再試行中...",
        zh: "Cline试图在没有必需参数'{paramName}'值的情况下使用{toolName}{pathInfo}。重试中..."
    }
}
```

## Usage

### 1. Adding New Messages

Add new keys and translations to the `messages` object in `caret-src/utils/backend-i18n.ts`:

```typescript
const messages: BackendMessages = {
    // Existing messages...
    "new.key": {
        en: "English message with {param}",
        ko: "한국어 메시지 {param}와 함께",
        ja: "日本語メッセージ{param}付き",
        zh: "中文消息与{param}"
    }
}
```

### 2. Using in Backend

```typescript
// 1. Add import
const { backendT } = await import("../../../caret-src/utils/backend-i18n")

// 2. Translate message
const translatedMessage = backendT("new.key", this.chatSettings, {
    param: "actual_value"
})

// 3. Use
await this.say("error", translatedMessage)
```

## Template System

### Substitution Rules
- Template variables are defined in `{variableName}` format.
- Substituted with key-value pairs from the `params` object.
- Case-sensitive.
- Global substitution using regular expressions.

### Example
```typescript
// Template: "Hello {name}, you have {count} messages"
// Parameters: { name: "John", count: "5" }
// Result: "Hello John, you have 5 messages"
```

## Extensibility

### Adding New Languages
1. Add new language codes to each key in the `messages` object.
2. Provide translations for the new language.
3. Confirm support for the new language in frontend language settings.

### Adding New Features
- Pluralization handling
- Number formatting
- Date/time formatting
- Context-specific translations

## Caveats

1. **Language Fallback**: Falls back to English if the requested language is not available.
2. **Missing Key**: If a key is missing, returns the key itself with a warning log.
3. **Missing Parameter**: If a parameter corresponding to a template variable is missing, the variable remains as is.
4. **Asynchronous Import**: Use dynamic imports in the backend to prevent circular references.

## Applied Files

### Backend
- `src/core/task/index.ts`: `sayAndCreateMissingParamError()` method

### Frontend
- `webview-ui/src/components/chat/ChatRow.tsx`: Various system messages
- `webview-ui/src/components/chat/task-header/TaskTimelineTooltip.tsx`: Task completion messages

## Performance Considerations

- Minimize initial loading time by using dynamic imports.
- Message object loaded into memory only once.
- Regex caching currently not implemented (can be added if needed).
