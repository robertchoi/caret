# íŒŒì¼ ì €ì¥ ë° ì´ë¯¸ì§€ ë¡œë”© ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

> ğŸ¯ **ëª©ì **: VSCode í™•ì¥í”„ë¡œê·¸ë¨ ê°œë°œ ì‹œ íŒŒì¼ ì €ì¥ ê¶Œí•œê³¼ ì´ë¯¸ì§€ ë¡œë”© ê´€ë ¨ ë¬¸ì œë¥¼ ì‚¬ì „ì— ë°©ì§€í•˜ê³  í•´ê²°í•˜ëŠ” ê°€ì´ë“œ

## 1. VSCode ì›¹ë·° CSP (Content Security Policy) ë¬¸ì œ

### 1.1. ë¬¸ì œ ìƒí™©

VSCode ì›¹ë·°ì—ì„œ `asset://` í”„ë¡œí† ì½œì„ ì‚¬ìš©í•œ ì´ë¯¸ì§€ ë¡œë”© ì‹œ CSP ì •ì±… ìœ„ë°˜ ì—ëŸ¬ ë°œìƒ:

```
Refused to load the image 'asset:/assets/template_characters/ichika.png'
because it violates the following Content Security Policy directive:
"img-src 'self' https://*.vscode-cdn.net https: data:".
```

### 1.2. ì›ì¸ ë¶„ì„

- VSCode ì›¹ë·°ëŠ” ë³´ì•ˆìƒ `asset://` í”„ë¡œí† ì½œì„ í—ˆìš©í•˜ì§€ ì•ŠìŒ
- í—ˆìš©ë˜ëŠ” ì´ë¯¸ì§€ ì†ŒìŠ¤: `'self'`, `https://*.vscode-cdn.net`, `https:`, `data:`
- `data:` URI ìŠ¤í‚¤ë§ˆë§Œì´ ë¡œì»¬ ì´ë¯¸ì§€ë¥¼ ì•ˆì „í•˜ê²Œ ë¡œë“œí•  ìˆ˜ ìˆìŒ

### 1.3. í•´ê²° ë°©ë²•

**Base64 ë°ì´í„° URI ë³€í™˜ ì‚¬ìš©:**

```typescript
// âŒ ì˜ëª»ëœ ë°©ë²•: asset:// í”„ë¡œí† ì½œ ì‚¬ìš©
const imageUri = "asset:/assets/template_characters/sarang.png"

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•: Base64 ë°ì´í„° URI ë³€í™˜
const convertImageUri = async (assetUri: string): Promise<string> => {
	if (!assetUri.startsWith("asset:/assets/")) {
		return assetUri
	}

	try {
		// íŒŒì¼ ê²½ë¡œ êµ¬ì„±
		const imagePath = path.join(context.extensionPath, "caret-assets", assetUri.replace("asset:/assets/", ""))

		// Base64 ë³€í™˜
		const imageBuffer = await fs.readFile(imagePath)
		const ext = path.extname(imagePath).toLowerCase()
		const mimeType =
			ext === ".png"
				? "image/png"
				: ext === ".jpg" || ext === ".jpeg"
					? "image/jpeg"
					: ext === ".webp"
						? "image/webp"
						: "image/png"

		return `data:${mimeType};base64,${imageBuffer.toString("base64")}`
	} catch (error) {
		caretLogger.error(`Failed to convert image URI: ${assetUri}`, error)
		return assetUri // ì›ë³¸ URI ë°˜í™˜ìœ¼ë¡œ í´ë°±
	}
}
```

### 1.4. êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­

1. **MIME íƒ€ì… ì •í™•íˆ ì„¤ì •**: íŒŒì¼ í™•ì¥ìì— ë§ëŠ” MIME íƒ€ì… ì‚¬ìš©
2. **ì—ëŸ¬ ì²˜ë¦¬**: íŒŒì¼ì´ ì—†ì„ ê²½ìš° ì ì ˆí•œ í´ë°± ì œê³µ
3. **ë¡œê¹…**: ë³€í™˜ ê³¼ì •ì„ ë¡œê·¸ë¡œ ê¸°ë¡í•˜ì—¬ ë””ë²„ê¹… ì§€ì›
4. **ì„±ëŠ¥ ê³ ë ¤**: í° ì´ë¯¸ì§€ëŠ” ìºì‹± ê³ ë ¤

## 2. ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ ë° ì €ì¥ì†Œ í˜¼ì¬ ë¬¸ì œ

### 2.1. ë¬¸ì œ ìƒí™©

í…œí”Œë¦¿ ì´ë¯¸ì§€ë¥¼ ì˜ëª»ëœ ê²½ë¡œì—ì„œ ì°¾ìœ¼ë ¤ë‹¤ ì‹¤íŒ¨í•˜ëŠ” ìƒí™©:

```typescript
// âŒ ë¬¸ì œ: globalStorageì—ì„œ í…œí”Œë¦¿ ì´ë¯¸ì§€ë¥¼ ì°¾ìœ¼ë ¤ í•¨
const globalStoragePath = path.join(context.globalStorageUri.fsPath, "personas", fileName)
// ê²°ê³¼: íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ ë¡œë”© ì‹¤íŒ¨
```

### 2.2. ê²½ë¡œ êµ¬ë¶„ ê·œì¹™

| ì´ë¯¸ì§€ íƒ€ì…              | ì €ì¥ ìœ„ì¹˜                           | ìš©ë„                            | ì ‘ê·¼ ë°©ë²•                  |
| ------------------------ | ----------------------------------- | ------------------------------- | -------------------------- |
| **í…œí”Œë¦¿ ìºë¦­í„° ì´ë¯¸ì§€** | `caret-assets/template_characters/` | ê³ ì •ëœ í…œí”Œë¦¿ ìºë¦­í„° ì´ë¯¸ì§€     | Extension path + íŒŒì¼ëª…    |
| **í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€** | `globalStorage/personas/`           | ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ í˜„ì¬ í˜ë¥´ì†Œë‚˜ | GlobalStorage URI + íŒŒì¼ëª… |
| **ì‚¬ìš©ì ì—…ë¡œë“œ ì´ë¯¸ì§€** | `globalStorage/personas/`           | ì‚¬ìš©ì ì»¤ìŠ¤í…€ ì´ë¯¸ì§€            | GlobalStorage URI + íŒŒì¼ëª… |

### 2.3. ì˜¬ë°”ë¥¸ êµ¬í˜„ íŒ¨í„´

```typescript
const loadTemplateImage = async (templateImageUri: string): Promise<string> => {
	if (templateImageUri.startsWith("asset:/assets/template_characters/")) {
		// í…œí”Œë¦¿ ì´ë¯¸ì§€ëŠ” caret-assetsì—ì„œ ë¡œë“œ
		const imagePath = path.join(context.extensionPath, "caret-assets", templateImageUri.replace("asset:/assets/", ""))
		return await convertToBase64(imagePath)
	}
	return templateImageUri
}

const loadCurrentPersonaImage = async (): Promise<{ avatarUri: string; thinkingAvatarUri: string }> => {
	// í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ëŠ” globalStorageì—ì„œ ë¡œë“œ
	const globalStoragePath = path.join(context.globalStorageUri.fsPath, "personas")

	const avatarPath = path.join(globalStoragePath, "agent_profile.png")
	const thinkingPath = path.join(globalStoragePath, "agent_thinking.png")

	return {
		avatarUri: await convertToBase64(avatarPath),
		thinkingAvatarUri: await convertToBase64(thinkingPath),
	}
}
```

## 3. í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ í‘œì‹œ ë¡œì§ í˜¼ì¬ ë¬¸ì œ

### 3.1. ë¬¸ì œ ìƒí™©

ì„œë¡œ ë‹¤ë¥¸ ìš©ë„ì˜ ì»´í¬ë„ŒíŠ¸ê°€ ë™ì¼í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ëª»ëœ ì´ë¯¸ì§€ë¥¼ í‘œì‹œ:

- **PersonaAvatar** (ì±„íŒ…ìš©): í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ í‘œì‹œí•´ì•¼ í•¨
- **PersonaManagement** (ì„¤ì •ìš©): í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ í‘œì‹œí•´ì•¼ í•¨
- **PersonaTemplateSelector** (ì„ íƒìš©): í…œí”Œë¦¿ ìºë¦­í„° ì´ë¯¸ì§€ í‘œì‹œí•´ì•¼ í•¨

í•˜ì§€ë§Œ ëª¨ë‘ `REQUEST_TEMPLATE_CHARACTERS`ë¥¼ ì‚¬ìš©í•´ì„œ í…œí”Œë¦¿ ì´ë¯¸ì§€ê°€ í˜„ì¬ í˜ë¥´ì†Œë‚˜ë¡œ ì˜ëª» í‘œì‹œë¨.

### 3.2. ë©”ì‹œì§€ íƒ€ì… ë¶„ë¦¬ í•´ê²°ì±…

**ìš©ë„ë³„ ë©”ì‹œì§€ íƒ€ì… ì •ì˜:**

```typescript
// WebviewMessage.ts
export interface WebviewMessage {
  type:
    | "REQUEST_TEMPLATE_CHARACTERS"  // í…œí”Œë¦¿ ì„ íƒìš©
    | "REQUEST_PERSONA_IMAGES"       // í˜„ì¬ í˜ë¥´ì†Œë‚˜ í‘œì‹œìš©
    | // ... ê¸°íƒ€ íƒ€ì…ë“¤
}

// ExtensionMessage.ts
export interface ExtensionMessage {
  type:
    | "RESPONSE_TEMPLATE_CHARACTERS" // í…œí”Œë¦¿ ëª©ë¡ ì‘ë‹µ
    | "RESPONSE_PERSONA_IMAGES"      // í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ ì‘ë‹µ
    | // ... ê¸°íƒ€ íƒ€ì…ë“¤
}
```

**Controllerì—ì„œ ë¶„ë¦¬ ì²˜ë¦¬:**

```typescript
// Controller
case "REQUEST_TEMPLATE_CHARACTERS": {
  // í…œí”Œë¦¿ ìºë¦­í„° ëª©ë¡ ë°˜í™˜ (ì„ íƒìš©)
  const templates = await loadTemplateCharacters()
  this.postMessageToWebview({
    type: "RESPONSE_TEMPLATE_CHARACTERS",
    payload: templates
  })
  break
}

case "REQUEST_PERSONA_IMAGES": {
  // í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ë§Œ ë°˜í™˜ (í‘œì‹œìš©)
  const personaImages = await loadCurrentPersonaImages()
  this.postMessageToWebview({
    type: "RESPONSE_PERSONA_IMAGES",
    payload: personaImages
  })
  break
}
```

### 3.3. ì»´í¬ë„ŒíŠ¸ë³„ ì‚¬ìš© íŒ¨í„´

```typescript
// PersonaAvatar.tsx - ì±„íŒ…ìš© í˜„ì¬ í˜ë¥´ì†Œë‚˜ í‘œì‹œ
useEffect(() => {
	vscode.postMessage({ type: "REQUEST_PERSONA_IMAGES" })
}, [])

// PersonaManagement.tsx - ì„¤ì •ìš© í˜„ì¬ í˜ë¥´ì†Œë‚˜ í‘œì‹œ
useEffect(() => {
	vscode.postMessage({ type: "REQUEST_PERSONA_IMAGES" })
	vscode.postMessage({ type: "REQUEST_TEMPLATE_CHARACTERS" }) // í…œí”Œë¦¿ ëª©ë¡ë„ í•„ìš”
}, [])

// PersonaTemplateSelector.tsx - í…œí”Œë¦¿ ì„ íƒìš©
useEffect(() => {
	vscode.postMessage({ type: "REQUEST_TEMPLATE_CHARACTERS" })
}, [])
```

## 4. íŒŒì¼ ì—…ë¡œë“œ ë° ê¶Œí•œ ë¬¸ì œ

### 4.1. globalStorage ë””ë ‰í† ë¦¬ ê¶Œí•œ

VSCodeëŠ” globalStorage ë””ë ‰í† ë¦¬ì— ëŒ€í•œ ì½ê¸°/ì“°ê¸° ê¶Œí•œì„ ìë™ìœ¼ë¡œ ì œê³µí•˜ì§€ë§Œ, ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ:

```typescript
const ensurePersonaDirectoryExists = async (context: vscode.ExtensionContext): Promise<string> => {
	const personaDir = path.join(context.globalStorageUri.fsPath, "personas")

	try {
		await fs.access(personaDir)
	} catch {
		// ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
		await fs.mkdir(personaDir, { recursive: true })
		caretLogger.info(`Created personas directory: ${personaDir}`)
	}

	return personaDir
}
```

### 4.2. íŒŒì¼ ì—…ë¡œë“œ ì‹œ ê¶Œí•œ ì²´í¬

```typescript
const savePersonaImage = async (
	context: vscode.ExtensionContext,
	imageType: "normal" | "thinking",
	base64Data: string,
): Promise<string> => {
	const personaDir = await ensurePersonaDirectoryExists(context)
	const fileName = imageType === "normal" ? "agent_profile.png" : "agent_thinking.png"
	const filePath = path.join(personaDir, fileName)

	try {
		// Base64 ë°ì´í„°ë¥¼ ë²„í¼ë¡œ ë³€í™˜
		const imageBuffer = Buffer.from(base64Data.split(",")[1], "base64")

		// íŒŒì¼ ì“°ê¸° ê¶Œí•œ ì²´í¬
		await fs.access(path.dirname(filePath), fs.constants.W_OK)

		// íŒŒì¼ ì €ì¥
		await fs.writeFile(filePath, imageBuffer)

		caretLogger.info(`Persona image saved: ${filePath}`)
		return filePath
	} catch (error) {
		caretLogger.error(`Failed to save persona image: ${filePath}`, error)
		throw new Error(`Failed to save persona image: ${error.message}`)
	}
}
```

## 5. TypeScript íƒ€ì… ì•ˆì „ì„± í™•ë³´

### 5.1. ë©”ì‹œì§€ íƒ€ì… ì •ì˜ ì™„ì„±ë„

ìƒˆë¡œìš´ ë©”ì‹œì§€ íƒ€ì…ì„ ì¶”ê°€í•  ë•ŒëŠ” ê´€ë ¨ëœ ëª¨ë“  íƒ€ì… ì •ì˜ë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•¨:

```typescript
// 1. WebviewMessage.ts ì—…ë°ì´íŠ¸
export interface WebviewMessage {
  type:
    | "REQUEST_PERSONA_IMAGES"  // ìƒˆ íƒ€ì… ì¶”ê°€
    | // ... ê¸°ì¡´ íƒ€ì…ë“¤
}

// 2. ExtensionMessage.ts ì—…ë°ì´íŠ¸
export interface ExtensionMessage {
  type:
    | "RESPONSE_PERSONA_IMAGES" // ìƒˆ íƒ€ì… ì¶”ê°€
    | // ... ê¸°ì¡´ íƒ€ì…ë“¤
}

// 3. í˜ì´ë¡œë“œ íƒ€ì… ì •ì˜
export interface PersonaImagesPayload {
  avatarUri: string
  thinkingAvatarUri: string
}
```

### 5.2. ì»´íŒŒì¼ ì—ëŸ¬ ì‚¬ì „ ë°©ì§€

íƒ€ì… ì¶”ê°€ í›„ ì¦‰ì‹œ ì»´íŒŒì¼ í™•ì¸:

```bash
npm run compile
```

íƒ€ì… ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ëª¨ë“  ê´€ë ¨ íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•œ í›„ ë‹¤ì‹œ ì»´íŒŒì¼í•´ì•¼ í•¨.

## 6. ë””ë²„ê¹… ë° ë¡œê¹… ì „ëµ

### 6.1. ì´ë¯¸ì§€ ë¡œë”© ê³¼ì • ë¡œê¹…

```typescript
const convertImageUri = async (uri: string): Promise<string> => {
	caretLogger.info(`[ImageLoading] Converting URI: ${uri}`)

	try {
		const result = await performConversion(uri)
		caretLogger.info(`[ImageLoading] Success: ${uri} -> data:${mimeType} (${buffer.length} bytes)`)
		return result
	} catch (error) {
		caretLogger.error(`[ImageLoading] Failed: ${uri}`, error)
		throw error
	}
}
```

### 6.2. íŒŒì¼ ê¶Œí•œ ë¬¸ì œ ì§„ë‹¨

```typescript
const diagnoseFilePermissions = async (filePath: string): Promise<void> => {
	try {
		const stats = await fs.stat(filePath)
		caretLogger.info(`[FilePermissions] ${filePath}:`, {
			exists: true,
			size: stats.size,
			isFile: stats.isFile(),
			isDirectory: stats.isDirectory(),
		})

		// ì½ê¸° ê¶Œí•œ ì²´í¬
		await fs.access(filePath, fs.constants.R_OK)
		caretLogger.info(`[FilePermissions] Read access: OK`)

		// ì“°ê¸° ê¶Œí•œ ì²´í¬ (ë””ë ‰í† ë¦¬ì˜ ê²½ìš°)
		if (stats.isDirectory()) {
			await fs.access(filePath, fs.constants.W_OK)
			caretLogger.info(`[FilePermissions] Write access: OK`)
		}
	} catch (error) {
		caretLogger.error(`[FilePermissions] ${filePath}:`, error)
	}
}
```

## 7. ì²´í¬ë¦¬ìŠ¤íŠ¸

### 7.1. ì´ë¯¸ì§€ ë¡œë”© êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] CSP ì •ì±… ì¤€ìˆ˜ (asset:// ëŒ€ì‹  data: URI ì‚¬ìš©)
- [ ] ì˜¬ë°”ë¥¸ íŒŒì¼ ê²½ë¡œ ì‚¬ìš© (í…œí”Œë¦¿ vs ì‚¬ìš©ì ì´ë¯¸ì§€)
- [ ] MIME íƒ€ì… ì •í™•íˆ ì„¤ì •
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° í´ë°± ì œê³µ
- [ ] ë¡œê¹…ìœ¼ë¡œ ë””ë²„ê¹… ì§€ì›
- [ ] TypeScript íƒ€ì… ì •ì˜ ì™„ì„±

### 7.2. íŒŒì¼ ì €ì¥ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ìƒì„±
- [ ] íŒŒì¼ ê¶Œí•œ ì²´í¬
- [ ] Base64 ë°ì´í„° ì˜¬ë°”ë¥¸ ë³€í™˜
- [ ] ì €ì¥ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê¹…
- [ ] ì‚¬ìš©ìì—ê²Œ ì ì ˆí•œ í”¼ë“œë°± ì œê³µ

### 7.3. ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ìš©ë„ë³„ ë©”ì‹œì§€ íƒ€ì… ë¶„ë¦¬
- [ ] Controllerì—ì„œ ìš”ì²­ íƒ€ì…ë³„ ì ì ˆí•œ ì‘ë‹µ
- [ ] ì»´í¬ë„ŒíŠ¸ë³„ ì˜¬ë°”ë¥¸ ë©”ì‹œì§€ íƒ€ì… ì‚¬ìš©
- [ ] TypeScript ì»´íŒŒì¼ ì—ëŸ¬ í•´ê²°

---

> ğŸ’¡ **íŒ**: ì´ ê°€ì´ë“œì˜ íŒ¨í„´ë“¤ì„ ë”°ë¥´ë©´ VSCode í™•ì¥í”„ë¡œê·¸ë¨ì—ì„œ íŒŒì¼ ì €ì¥ê³¼ ì´ë¯¸ì§€ ë¡œë”© ê´€ë ¨ ë¬¸ì œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ CSP ì •ì±…ê³¼ ê²½ë¡œ í˜¼ì¬ ë¬¸ì œëŠ” ì‚¬ì „ì— ì„¤ê³„ ë‹¨ê³„ì—ì„œ ê³ ë ¤í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.
