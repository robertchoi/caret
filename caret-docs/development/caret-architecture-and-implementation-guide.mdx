# Caret ì•„í‚¤í…ì²˜ ë° êµ¬í˜„ ê°€ì´ë“œ

## Table of Contents

-   [Project Overview](#project-overview)
-   [Architecture Principles](#architecture-principles)
-   [Development Patterns](#development-patterns)
-   [Implementation Strategy](#implementation-strategy)
-   [Core Class Extension Guide](#core-class-extension-guide)
-   [Build System](#build-system)
-   [Development Workflow](#development-workflow)
-   [Quality Assurance](#quality-assurance)
-   [Cline Pattern Best Practices](#cline-pattern-best-practices)
-   [Message Flow Analysis](#message-flow-analysis)
-   [Frontend-Backend Interaction Patterns](#frontend-backend-interaction-patterns)
-   [Circular Message Prevention](#circular-message-prevention)

## 1. ê°œìš”

ì´ ë¬¸ì„œëŠ” Caret í”„ë¡œì íŠ¸ê°€ **Fork ê¸°ë°˜ ì•„í‚¤í…ì²˜**ë¥¼ í†µí•´ Clineì˜ ì•ˆì •ì ì¸ ê¸°ë°˜ ìœ„ì—ì„œ ê³ ìœ ì˜ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤. Caretì€ Cline ì½”ë“œë² ì´ìŠ¤ë¥¼ ì§ì ‘ í¬í•¨í•˜ì—¬ ê¸°ì¡´ ê¸°ëŠ¥ì„ ìµœëŒ€í•œ í™œìš©í•˜ë©´ì„œ, í•„ìš”í•œ ë¶€ë¶„ë§Œ ì„ íƒì ìœ¼ë¡œ í™•ì¥í•˜ê±°ë‚˜ ëŒ€ì²´í•˜ëŠ” ì „ëµì„ ì±„íƒí•©ë‹ˆë‹¤.

## 2. Fork ê¸°ë°˜ ì•„í‚¤í…ì²˜ ì›ì¹™

### 2.1. Cline ì½”ë“œ ì§ì ‘ í¬í•¨

Caretì€ [Cline](https://github.com/cline/cline) í”„ë¡œì íŠ¸ì˜ **Fork**ë¡œ, Clineì˜ ì „ì²´ ì½”ë“œë² ì´ìŠ¤ë¥¼ `src/` ë””ë ‰í† ë¦¬ì— ì§ì ‘ í¬í•¨í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´:

-   Clineì˜ ì•ˆì •ì ì´ê³  ê²€ì¦ëœ ê¸°ëŠ¥ì„ ê·¸ëŒ€ë¡œ í™œìš©
-   ì—…ìŠ¤íŠ¸ë¦¼ ë³€ê²½ì‚¬í•­ì„ Git mergeë¥¼ í†µí•´ íš¨ìœ¨ì ìœ¼ë¡œ í†µí•©
-   ë³µì¡í•œ ì„œë¸Œëª¨ë“ˆ ê´€ë¦¬ë‚˜ ì™¸ë¶€ ì˜ì¡´ì„± ì—†ì´ ë‹¨ìˆœí•œ êµ¬ì¡° ìœ ì§€

### 2.2. ìµœì†Œ í™•ì¥ ì›ì¹™

Caretì˜ í™•ì¥ ì½”ë“œëŠ” ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤:

-   **Cline ì½”ë“œ ë³´ì¡´**: `src/`, `webview-ui/` ì›ë³¸ íŒŒì¼ì€ ê°€ëŠ¥í•œ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
-   **ìµœì†Œ ì§„ì…ì **: `caret-src/extension.ts`ë¥¼ í†µí•´ Cline ëª¨ë“ˆ í™œìš©
-   **ì ì§„ì  í™•ì¥**: í•„ìš”í•œ ê¸°ëŠ¥ë§Œ Caret ì „ìš©ìœ¼ë¡œ êµ¬í˜„

### 2.3. í•µì‹¬ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
caret/
â”œâ”€â”€ src/                      # Cline ì›ë³¸ ì½”ë“œ (ë³´ì¡´)
â”‚   â”œâ”€â”€ extension.ts          # Cline ë©”ì¸ ì§„ì…ì 
â”‚   â”œâ”€â”€ core/                 # Cline í•µì‹¬ ë¡œì§
â”‚   â”‚   â”œâ”€â”€ webview/          # WebviewProvider
â”‚   â”‚   â”œâ”€â”€ task/             # Task ê´€ë¦¬
â”‚   â”‚   â””â”€â”€ prompts/          # í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œ
â”‚   â”œâ”€â”€ shared/               # ê³µí†µ íƒ€ì…/ìœ í‹¸ë¦¬í‹°
â”‚   â””â”€â”€ api/                  # AI í”„ë¡œë°”ì´ë”ë“¤
â”œâ”€â”€ caret-src/                # Caret í™•ì¥ ê¸°ëŠ¥ (ìµœì†Œí•œ)
â”‚   â”œâ”€â”€ extension.ts          # Caret ì§„ì…ì  (src/ ëª¨ë“ˆ í™œìš©)
â”‚   â””â”€â”€ core/
â”‚       â””â”€â”€ webview/
â”‚           â””â”€â”€ CaretProvider.ts  # Cline WebviewProvider í™•ì¥
â”œâ”€â”€ caret-assets/             # Caret ì „ìš© ì—ì…‹
â”‚   â”œâ”€â”€ template_characters/  # AI ìºë¦­í„° í…œí”Œë¦¿
â”‚   â”œâ”€â”€ rules/                # ê¸°ë³¸ ëª¨ë“œ ë° ë£° ì •ì˜
â”‚   â””â”€â”€ icons/                # í”„ë¡œì íŠ¸ ì•„ì´ì½˜
â”œâ”€â”€ caret-docs/               # Caret ì „ìš© ë¬¸ì„œ
â””â”€â”€ webview-ui/               # í”„ë¡ íŠ¸ì—”ë“œ (Cline ë¹Œë“œ ì‹œìŠ¤í…œ í™œìš©)
    â”œâ”€â”€ src/components/       # Cline ì›ë³¸ ì»´í¬ë„ŒíŠ¸ (ë³´ì¡´)
    â”œâ”€â”€ src/caret/            # Caret ì „ìš© ì»´í¬ë„ŒíŠ¸
    â”œâ”€â”€ src/utils/            # Cline ìœ í‹¸ë¦¬í‹° + Caret ì¶”ê°€
    â””â”€â”€ src/locale/           # Caret ë‹¤êµ­ì–´ ì§€ì›
```

## 3. Cline ê¸°ë°˜ í•µì‹¬ ì•„í‚¤í…ì²˜ íŒ¨í„´

### 3.1. Task ì‹¤í–‰ ì‹œìŠ¤í…œ (Cline íŒ¨í„´ í™œìš©)

Caretì€ Clineì˜ ê²€ì¦ëœ Task ì‹¤í–‰ ì•„í‚¤í…ì²˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¶•ë©ë‹ˆë‹¤:

```typescript
// caret-src/core/task/CaretTask.ts (Cline Task í™•ì¥)
import { Task } from "../../../src/core/task/Task"

export class CaretTask extends Task {
	// Clineì˜ í•µì‹¬ ì‹¤í–‰ ë£¨í”„ í™œìš©
	async initiateTaskLoop(userContent: UserContent, isNewTask: boolean) {
		while (!this.abort) {
			// 1. API ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¼ ì‘ë‹µ (Cline íŒ¨í„´)
			const stream = this.attemptApiRequest()

			// 2. ì½˜í…ì¸  ë¸”ë¡ íŒŒì‹± ë° í‘œì‹œ (Cline íŒ¨í„´)
			for await (const chunk of stream) {
				switch (chunk.type) {
					case "text":
						this.assistantMessageContent = parseAssistantMessageV2(chunk.text)
						await this.presentAssistantMessage()
						break
					case "tool_use":
						// Caret ê³ ìœ  ë„êµ¬ ì‹¤í–‰ ë¡œì§ ì¶”ê°€
						await this.handleCaretToolExecution(chunk)
						break
				}
			}

			// 3. ë„êµ¬ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸° (Cline íŒ¨í„´)
			await pWaitFor(() => this.userMessageContentReady)

			// 4. ê²°ê³¼ì™€ í•¨ê»˜ ë£¨í”„ ê³„ì† (Cline íŒ¨í„´)
			const recDidEndLoop = await this.recursivelyMakeClineRequests(this.userMessageContent)
		}
	}

	// Caret ê³ ìœ  ë„êµ¬ ì‹¤í–‰ ë¡œì§
	private async handleCaretToolExecution(chunk: ToolBlock) {
		// Clineì˜ ê¸°ë³¸ ë„êµ¬ + Caret ì „ìš© ë„êµ¬ ì²˜ë¦¬
		if (this.isCaretSpecificTool(chunk.name)) {
			return await this.executeCaretTool(chunk)
		}

		// ê¸°ë³¸ì ìœ¼ë¡œëŠ” Clineì˜ ë„êµ¬ ì‹¤í–‰ ì‚¬ìš©
		return await super.executeToolWithApproval(chunk)
	}
}
```

### 3.2. ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¬ë° ì‹œìŠ¤í…œ (Cline íŒ¨í„´)

Clineì˜ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì•„í‚¤í…ì²˜ë¥¼ í™œìš©í•˜ì—¬ ì•ˆì •ì ì¸ ë©”ì‹œì§€ ì²˜ë¦¬:

```typescript
// caret-src/core/webview/CaretProvider.ts
import { WebviewProvider } from "../../../src/core/webview/index"

export class CaretProvider extends WebviewProvider {
	// Clineì˜ ìŠ¤íŠ¸ë¦¬ë° ì ê¸ˆ ë©”ì»¤ë‹ˆì¦˜ í™œìš©
	async presentAssistantMessage() {
		// Race condition ë°©ì§€ (Cline íŒ¨í„´)
		if (this.presentAssistantMessageLocked) {
			this.presentAssistantMessageHasPendingUpdates = true
			return
		}
		this.presentAssistantMessageLocked = true

		try {
			// í˜„ì¬ ì½˜í…ì¸  ë¸”ë¡ ì²˜ë¦¬ (Cline íŒ¨í„´)
			const block = this.assistantMessageContent[this.currentStreamingContentIndex]

			// ì½˜í…ì¸  íƒ€ì…ë³„ ì²˜ë¦¬ (Cline íŒ¨í„´ + Caret í™•ì¥)
			switch (block.type) {
				case "text":
					await this.say("text", content, undefined, block.partial)
					break
				case "tool_use":
					// Caret ì „ìš© ë„êµ¬ í‘œì‹œ ë¡œì§ ì¶”ê°€
					await this.handleCaretToolDisplay(block)
					break
				default:
					// Cline ê¸°ë³¸ ì²˜ë¦¬ ìœ„ì„
					await super.presentAssistantMessage()
			}

			// ë‹¤ìŒ ë¸”ë¡ìœ¼ë¡œ ì´ë™ (Cline íŒ¨í„´)
			if (!block.partial) {
				this.currentStreamingContentIndex++
			}
		} finally {
			this.presentAssistantMessageLocked = false

			// ëŒ€ê¸° ì¤‘ì¸ ì—…ë°ì´íŠ¸ ì²˜ë¦¬ (Cline íŒ¨í„´)
			if (this.presentAssistantMessageHasPendingUpdates) {
				this.presentAssistantMessageHasPendingUpdates = false
				await this.presentAssistantMessage()
			}
		}
	}
}
```

### 3.3. API ìš”ì²­ ë° í† í° ê´€ë¦¬ (Cline íŒ¨í„´)

Clineì˜ ê²€ì¦ëœ í† í° ê´€ë¦¬ì™€ ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ í™œìš©:

```typescript
// CaretTaskì—ì„œ Clineì˜ API ê´€ë¦¬ íŒ¨í„´ í™•ì¥
export class CaretTask extends Task {
	async *attemptApiRequest(previousApiReqIndex: number): ApiStream {
		// 1. MCP ì„œë²„ ì—°ê²° ëŒ€ê¸° (Cline íŒ¨í„´)
		await pWaitFor(() => this.controllerRef.deref()?.mcpHub?.isConnecting !== true)

		// 2. ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš° ê´€ë¦¬ (Cline íŒ¨í„´)
		const previousRequest = this.clineMessages[previousApiReqIndex]
		if (previousRequest?.text) {
			const { tokensIn, tokensOut } = JSON.parse(previousRequest.text || "{}")
			const totalTokens = (tokensIn || 0) + (tokensOut || 0)

			// ì»¨í…ìŠ¤íŠ¸ í•œê³„ ì ‘ê·¼ ì‹œ ëŒ€í™” ì¶•ì•½ (Cline íŒ¨í„´)
			if (totalTokens >= maxAllowedSize) {
				this.conversationHistoryDeletedRange = this.contextManager.getNextTruncationRange(
					this.apiConversationHistory,
					this.conversationHistoryDeletedRange,
					totalTokens / 2 > maxAllowedSize ? "quarter" : "half",
				)
			}
		}

		// 3. ìë™ ì¬ì‹œë„ê°€ í¬í•¨ëœ ìŠ¤íŠ¸ë¦¬ë° (Cline íŒ¨í„´)
		try {
			this.isWaitingForFirstChunk = true
			const firstChunk = await iterator.next()
			yield firstChunk.value
			this.isWaitingForFirstChunk = false

			// ë‚˜ë¨¸ì§€ ì²­í¬ ìŠ¤íŠ¸ë¦¬ë°
			yield* iterator
		} catch (error) {
			// 4. Caret ê³ ìœ  ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€
			if (this.isCaretSpecificError(error)) {
				yield* this.handleCaretApiError(error)
				return
			}

			// 5. Cline ê¸°ë³¸ ì—ëŸ¬ ì²˜ë¦¬ í™œìš©
			if (isOpenRouter && !this.didAutomaticallyRetryFailedApiRequest) {
				await setTimeoutPromise(1000)
				this.didAutomaticallyRetryFailedApiRequest = true
				yield* this.attemptApiRequest(previousApiReqIndex)
				return
			}

			// 6. ì‚¬ìš©ì ì¬ì‹œë„ ìš”ì²­ (Cline íŒ¨í„´)
			const { response } = await this.ask("api_req_failed", this.formatErrorWithStatusCode(error))
			if (response === "yesButtonClicked") {
				await this.say("api_req_retried")
				yield* this.attemptApiRequest(previousApiReqIndex)
				return
			}
		}
	}
}
```

### 3.4. ìƒíƒœ ê´€ë¦¬ ì•„í‚¤í…ì²˜ (Cline íŒ¨í„´)

Clineì˜ Controller â†” ExtensionStateContext í†µì‹  íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ Caret ìƒíƒœ ê´€ë¦¬:

```typescript
// caret-src/core/state/CaretStateManager.ts
import { Controller } from "../../../src/core/controller/index"

export class CaretStateManager extends Controller {
	// Clineì˜ ë‹¤ì¤‘ ì €ì¥ì†Œ íŒ¨í„´ í™œìš©
	async initializeCaretState() {
		// Global State: ëª¨ë“  VSCode ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ê³µìœ  (Cline íŒ¨í„´)
		const globalCaretSettings = await this.context.globalState.get("caret.settings", {})

		// Workspace State: í˜„ì¬ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì „ìš© (Cline íŒ¨í„´)
		const workspaceCaretData = await this.context.workspaceState.get("caret.workspace", {})

		// Secrets: ë¯¼ê°í•œ ì •ë³´ ì•ˆì „ ì €ì¥ (Cline íŒ¨í„´)
		const caretApiKeys = await this.context.secrets.get("caret.apiKeys")

		// Caret ê³ ìœ  ìƒíƒœ ì´ˆê¸°í™”
		await this.setupCaretSpecificState(globalCaretSettings, workspaceCaretData)
	}

	// Clineì˜ ì¸ìŠ¤í„´ìŠ¤ ê°„ ìƒíƒœ ë™ê¸°í™” íŒ¨í„´ í™œìš©
	async syncCaretStateAcrossInstances() {
		// íŒŒì¼ ê¸°ë°˜ ì €ì¥ì†Œ (Cline íŒ¨í„´)
		await this.saveCaretTaskHistory()

		// VSCode ê¸€ë¡œë²Œ ìƒíƒœ API (Cline íŒ¨í„´)
		await this.context.globalState.update("caret.lastSync", Date.now())

		// íŒŒì¼ ë³€ê²½ ë° ì„¤ì • ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ (Cline íŒ¨í„´)
		this.setupCaretStateListeners()
	}
}
```

### 3.5. ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬ ì‹œìŠ¤í…œ (Cline íŒ¨í„´)

Clineì˜ ê²¬ê³ í•œ ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´ì„ Caretì— ì ìš©:

```typescript
// CaretTask ì—ëŸ¬ ì²˜ë¦¬
export class CaretTask extends Task {
	async handleError(action: string, error: Error) {
		// 1. ì‘ì—… ì¤‘ë‹¨ í™•ì¸ (Cline íŒ¨í„´)
		if (this.abandoned) return

		// 2. Caret ê³ ìœ  ì—ëŸ¬ ë¶„ë¥˜
		const errorCategory = this.categorizeCaretError(error)

		// 3. ì—ëŸ¬ ë©”ì‹œì§€ í¬ë§·íŒ… (Cline íŒ¨í„´)
		const errorString = `Error ${action}: ${error.message}`

		// 4. ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ í‘œì‹œ (Cline íŒ¨í„´)
		await this.say("error", errorString)

		// 5. ë„êµ¬ ê²°ê³¼ì— ì—ëŸ¬ ì¶”ê°€ (Cline íŒ¨í„´)
		pushToolResult(formatResponse.toolError(errorString))

		// 6. ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (Cline íŒ¨í„´ + Caret í™•ì¥)
		await this.diffViewProvider.revertChanges()
		await this.browserSession.closeBrowser()
		await this.cleanupCaretResources() // Caret ê³ ìœ  ì •ë¦¬
	}

	// Caret ê³ ìœ  ì—ëŸ¬ ë¶„ë¥˜ ì‹œìŠ¤í…œ
	private categorizeCaretError(error: Error): CaretErrorCategory {
		if (error.message.includes("caret-specific")) {
			return CaretErrorCategory.CARET_FEATURE_ERROR
		}
		if (error.message.includes("api")) {
			return CaretErrorCategory.API_ERROR
		}
		return CaretErrorCategory.GENERAL_ERROR
	}

	// Caret ì „ìš© ë¦¬ì†ŒìŠ¤ ì •ë¦¬
	private async cleanupCaretResources() {
		// Caret ê³ ìœ  ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë¡œì§
		await this.caretLogger.flush()
		await this.caretStateManager.saveEmergencyState()
	}
}
```

## 4. êµ¬í˜„ ì „ëµ

### 4.1. ë°±ì—”ë“œ í™•ì¥ (caret-src)

**ëª©ì **: Clineì˜ í•µì‹¬ ê¸°ëŠ¥ì„ í™œìš©í•˜ë©´ì„œ Caret ê³ ìœ  ê¸°ëŠ¥ ì¶”ê°€

**êµ¬í˜„ ë°©ì‹**:

1. **Cline ëª¨ë“ˆ ì§ì ‘ í™œìš©**

    ```typescript
    // caret-src/extension.ts
    import { WebviewProvider } from "../src/core/webview/WebviewProvider"
    import { TaskManager } from "../src/core/task/TaskManager"

    // Cline ëª¨ë“ˆì„ ì§ì ‘ importí•˜ì—¬ í™œìš©
    export class CaretProvider extends WebviewProvider {
    	// Caret ê³ ìœ  ê¸°ëŠ¥ë§Œ ì¶”ê°€/ì˜¤ë²„ë¼ì´ë“œ
    }
    ```

2. **í´ë˜ìŠ¤ ìƒì†ì„ í†µí•œ í™•ì¥**

    ```typescript
    // caret-src/core/webview/CaretProvider.ts
    import { WebviewProvider } from "../../../src/core/webview/WebviewProvider"

    export class CaretProvider extends WebviewProvider {
    	// ê¸°ì¡´ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ
    	override async initialize(): Promise<void> {
    		await super.initialize()
    		// Caret ì „ìš© ì´ˆê¸°í™” ë¡œì§
    		await this.initializeCaretFeatures()
    	}

    	// ìƒˆë¡œìš´ ë©”ì„œë“œ ì¶”ê°€
    	private async initializeCaretFeatures(): Promise<void> {
    		// Caret ê³ ìœ  ê¸°ëŠ¥ êµ¬í˜„
    	}
    }
    ```

### 4.2. í”„ë¡ íŠ¸ì—”ë“œ í™•ì¥ (webview-ui)

**ëª©ì **: Clineì˜ React ë¹Œë“œ ì‹œìŠ¤í…œì„ ê·¸ëŒ€ë¡œ í™œìš©í•˜ë©´ì„œ UI í™•ì¥

**êµ¬í˜„ ë°©ì‹**:

1. **ì»´í¬ë„ŒíŠ¸ ì¶”ê°€**

    ```typescript
    // webview-ui/src/caret/CaretWelcome.tsx
    import React from 'react';
    import { useExtensionState } from '../context/ExtensionStateContext';

    export const CaretWelcome: React.FC = () => {
      const { state } = useExtensionState();

      return (
        <div className="caret-welcome">
          {/* Caret ì „ìš© ì›°ì»´ í˜ì´ì§€ */}
        </div>
      );
    };
    ```

2. **ë¼ìš°íŒ… ë¶„ê¸°**

    ```typescript
    // webview-ui/src/App.tsx ìˆ˜ì • (í•„ìš”ì‹œ)
    import { CaretWelcome } from './caret/CaretWelcome';

    function App() {
      const isCaretMode = /* Caret ëª¨ë“œ íŒë³„ ë¡œì§ */;

      if (isCaretMode) {
        return <CaretWelcome />;
      }

      // ê¸°ì¡´ Cline UI
      return <ClineApp />;
    }
    ```

3. **ìœ í‹¸ë¦¬í‹° ì¶”ê°€**
    ```typescript
    // webview-ui/src/utils/caret-i18n.ts
    // webview-ui/src/utils/caret-webview-logger.ts
    // Caret ì „ìš© ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    ```

### 4.3. í•„ìš”ì‹œ íŒŒì¼ êµì²´

**ì›ì¹™**: ìµœí›„ì˜ ìˆ˜ë‹¨ìœ¼ë¡œë§Œ ì‚¬ìš©, ë°˜ë“œì‹œ ë°±ì—… ìƒì„±

**êµ¬í˜„ ë°©ì‹**:

1. **ì›ë³¸ ë°±ì—…**

    ```bash
    # ì›ë³¸ íŒŒì¼ì„ .cline í™•ì¥ìë¡œ ë°±ì—…
    cp webview-ui/src/components/Welcome.tsx webview-ui/src/components/Welcome-tsx.cline
    ```

2. **Caret ë²„ì „ìœ¼ë¡œ êµì²´**

    ```typescript
    // webview-ui/src/components/Welcome.tsx (êµì²´ë¨)
    // Caret ì „ìš© Welcome ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
    ```

3. **ë¨¸ì§• ê°€ì´ë“œ ì—…ë°ì´íŠ¸**
    - `caret-docs/guides/upstream-merging.md`ì— êµì²´ íŒŒì¼ ì •ë³´ ê¸°ë¡

## 5. í•µì‹¬ í´ë˜ìŠ¤ í™•ì¥ ê°€ì´ë“œ: CaretProvider ì˜ˆì‹œ

Caretì˜ í•µì‹¬ `WebviewProvider`ëŠ” Clineì˜ `WebviewProvider`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤. ì´ë¥¼ ìˆ˜ì •í•  ë•ŒëŠ” ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤.

### 5.1. ê¸°ë³¸ ì›ì¹™: ìƒì†ì„ í†µí•œ ìµœì†Œ í™•ì¥

`CaretProvider`ëŠ” `ClineWebviewProvider`ë¥¼ `extends` í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ì½”ë“œ ì¬ì‚¬ìš©ì„±ì„ ë†’ì´ê³ , í–¥í›„ Clineì˜ ì—…ë°ì´íŠ¸ë¥¼ ë”°ë¼ê°€ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

```typescript
// caret-src/core/webview/CaretProvider.ts
import { WebviewProvider as ClineWebviewProvider } from "../../../src/core/webview/index"

export class CaretProvider extends ClineWebviewProvider {
	// ... í•„ìš”í•œ ìµœì†Œí•œì˜ ë¡œì§ë§Œ ì¶”ê°€ ...
}
```

### 5.2. `private` ë©¤ë²„ë¡œ ì¸í•œ ìƒì† ì œì•½ ë°œìƒ ì‹œ í•´ê²° ì ˆì°¨

ë§Œì•½ `ClineWebviewProvider`ì˜ `private` ì†ì„±(ì˜ˆ: `disposables`) ë•Œë¬¸ì— ê¸°ëŠ¥ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤ë©´, ë‹¤ìŒ ì ˆì°¨ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

1.  **ë¬´ë¦¬í•œ ì¬êµ¬í˜„ ê¸ˆì§€**: `CaretProvider`ì—ì„œ `resolveWebviewView`ì™€ ê°™ì€ ê±°ëŒ€í•œ ë©”ì†Œë“œë¥¼ í†µì§¸ë¡œ ë³µì‚¬í•˜ì—¬ ì¬êµ¬í˜„í•˜ëŠ” ê²ƒì€ **ì—„ê²©íˆ ê¸ˆì§€**ë©ë‹ˆë‹¤. ì´ëŠ” ë²„ê·¸ ë°œìƒì˜ ì£¼ìš” ì›ì¸ì´ ë©ë‹ˆë‹¤.
2.  **ì›ë³¸ íŒŒì¼ ë°±ì—…**: `src/core/webview/index.ts` íŒŒì¼ì˜ ë°±ì—…(`index-ts.cline`)ì„ ìƒì„±í•©ë‹ˆë‹¤.
3.  **ìµœì†Œí•œì˜ ì§ì ‘ ìˆ˜ì •**: `src/core/webview/index.ts` íŒŒì¼ì—ì„œ ë¬¸ì œê°€ ë˜ëŠ” `private` ì†ì„±ì„ `protected`ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. ì´ëŠ” ë‹¨ í•œ ì¤„ì˜ ìˆ˜ì •ìœ¼ë¡œ, ê°€ì¥ ì•ˆì „í•˜ê³  ëª…í™•í•œ í•´ê²°ì±…ì…ë‹ˆë‹¤.

    ```typescript
    // BEFORE
    private disposables: vscode.Disposable[] = [];

    // AFTER
    // CARET MODIFICATION: Allow child classes to access disposables for proper extension.
    protected disposables: vscode.Disposable[] = [];
    ```

4.  **`CaretProvider`ì—ì„œ ì˜¤ë²„ë¼ì´ë”©**: ì´ì œ `CaretProvider`ì—ì„œ `protected`ê°€ ëœ ë©¤ë²„ë¥¼ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ ë¡œì§ì„ ì˜¤ë²„ë¼ì´ë“œí•©ë‹ˆë‹¤.

ì´ ì ˆì°¨ëŠ” "ìµœì†Œ ìˆ˜ì •ì˜ ì›ì¹™"ì„ ì§€í‚¤ë©´ì„œ, ë™ì‹œì— ê¹¨ë—í•˜ê³  ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ìµœì„ ì˜ ë°©ë²•ì…ë‹ˆë‹¤.

## 6. ë¹Œë“œ ì‹œìŠ¤í…œ

### 6.1. í†µí•© ë¹Œë“œ í”„ë¡œì„¸ìŠ¤

Caretì€ Clineì˜ ê¸°ì¡´ ë¹Œë“œ ì‹œìŠ¤í…œì„ ìµœëŒ€í•œ í™œìš©:

```bash
# Protocol Buffer ì»´íŒŒì¼
npm run protos

# TypeScript ì»´íŒŒì¼ (src/ + caret-src/ í†µí•©)
npm run compile

# Webview UI ë¹Œë“œ (Vite)
cd webview-ui && npm run build
```

### 6.2. ë¹Œë“œ ì„¤ì • ìµœì í™”

-   **tsconfig.json**: `src/`ì™€ `caret-src/` ê²½ë¡œ í¬í•¨
-   **package.json**: Cline ìŠ¤í¬ë¦½íŠ¸ í™•ì¥
-   **vite.config.ts**: Caret ì»´í¬ë„ŒíŠ¸ ê²½ë¡œ ì¶”ê°€

## 7. ê°œë°œ ì›Œí¬í”Œë¡œìš°

### 7.1. ìƒˆ ê¸°ëŠ¥ ê°œë°œ

1. **ìš”êµ¬ì‚¬í•­ ë¶„ì„**: Cline ê¸°ì¡´ ê¸°ëŠ¥ìœ¼ë¡œ ì¶©ì¡± ê°€ëŠ¥í•œì§€ í™•ì¸
2. **êµ¬í˜„ ë°©ì‹ ê²°ì •**: í™•ì¥ vs êµì²´ vs ì‹ ê·œ ì¶”ê°€
3. **ìµœì†Œ êµ¬í˜„**: ê°€ëŠ¥í•œ Cline ëª¨ë“ˆ ì¬ì‚¬ìš©
4. **í…ŒìŠ¤íŠ¸ ë° ë¡œê¹…**: ëª¨ë“  ìƒˆ ê¸°ëŠ¥ì— í…ŒìŠ¤íŠ¸ì™€ ë¡œê¹… í¬í•¨

### 6.2. ì—…ìŠ¤íŠ¸ë¦¼ ë¨¸ì§•

1. **Cline ë³€ê²½ì‚¬í•­ í™•ì¸**
2. **ì¶©ëŒ í•´ê²°**: ì£¼ë¡œ `src/` ë””ë ‰í† ë¦¬ì—ì„œ ë°œìƒ
3. **Caret ê¸°ëŠ¥ í˜¸í™˜ì„± ê²€ì¦**
4. **ë¬¸ì„œ ì—…ë°ì´íŠ¸**

## 8. í’ˆì§ˆ ê´€ë¦¬

### 8.1. í…ŒìŠ¤íŠ¸ ì „ëµ

-   **Cline ê¸°ëŠ¥**: ì›ë³¸ í…ŒìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ìœ ì§€
-   **Caret í™•ì¥**: 100% í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ëª©í‘œ
-   **í†µí•© í…ŒìŠ¤íŠ¸**: Cline-Caret ì—°ë™ ê²€ì¦

### 8.2. ë¡œê¹… ì‹œìŠ¤í…œ (Cline íŒ¨í„´ í™•ì¥)

```typescript
// caret-src/utils/caret-logger.ts
import { Logger } from "../src/services/logging/Logger"

export class CaretLogger extends Logger {
	constructor(name: string) {
		super(`Caret.${name}`)
	}

	// Cline ë¡œê¹… íŒ¨í„´ + Caret ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
	logWithContext(level: LogLevel, message: string, context?: any) {
		const caretContext = {
			...context,
			caretVersion: this.getCaretVersion(),
			timestamp: new Date().toISOString(),
		}

		super.log(level, message, caretContext)
	}
}

// ì‚¬ìš© ì˜ˆì‹œ
export const caretLogger = new CaretLogger("Core")
caretLogger.logWithContext("info", "Caret feature initialized", { feature: "welcome" })
```

## 9. Cline íŒ¨í„´ í™œìš© ëª¨ë²” ì‚¬ë¡€

### 9.1. ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ëª¨ë²” ì‚¬ë¡€

-   **ì ê¸ˆ ë©”ì»¤ë‹ˆì¦˜**: race condition ë°©ì§€ë¥¼ ìœ„í•œ ì ì ˆí•œ ì ê¸ˆ ì‚¬ìš©
-   **ë¶€ë¶„ ì—…ë°ì´íŠ¸**: ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ë¶€ë¶„ ì½˜í…ì¸  ì•ˆì „ ì²˜ë¦¬
-   **ì—ëŸ¬ ë³µêµ¬**: ìŠ¤íŠ¸ë¦¼ ì¤‘ë‹¨ ì‹œ ì ì ˆí•œ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜

### 8.2. ìƒíƒœ ê´€ë¦¬ ëª¨ë²” ì‚¬ë¡€

-   **ë‹¤ì¤‘ ì €ì¥ì†Œ**: Global/Workspace/Secrets ì ì ˆí•œ ë¶„ë¦¬ ì‚¬ìš©
-   **ì¸ìŠ¤í„´ìŠ¤ ë™ê¸°í™”**: ì—¬ëŸ¬ í™•ì¥ ì¸ìŠ¤í„´ìŠ¤ ê°„ ìƒíƒœ ì¼ê´€ì„± ìœ ì§€
-   **ìºì‹œ ê´€ë¦¬**: ì„±ëŠ¥ì„ ìœ„í•œ ì ì ˆí•œ ìºì‹± ì „ëµ

### 8.3. API ê´€ë¦¬ ëª¨ë²” ì‚¬ë¡€

-   **í† í° ì¶”ì **: ì •í™•í•œ í† í° ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
-   **ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬**: ìë™ ëŒ€í™” ì¶•ì•½ìœ¼ë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í™•ë³´
-   **ì¬ì‹œë„ ë¡œì§**: ì¼ì‹œì  ì˜¤ë¥˜ì— ëŒ€í•œ ê²¬ê³ í•œ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜

## 10. ë©”ì‹œì§€ í”Œë¡œìš° ë¶„ì„ ë° ìˆœí™˜ ë©”ì‹œì§€ ë°©ì§€

### 10.1. Cline ë©”ì‹œì§€ ì‹œìŠ¤í…œ ì´í•´

Clineì€ **gRPC ê¸°ë°˜ ë©”ì‹œì§€ ì‹œìŠ¤í…œ**ì„ ì‚¬ìš©í•˜ì—¬ webviewì™€ ë°±ì—”ë“œ ê°„ í†µì‹ :

```
webview (React) â†” gRPC â†” Extension Host (Node.js)
```

**í•µì‹¬ ì»´í¬ë„ŒíŠ¸**:

-   **StateServiceClient**: webview â†’ ë°±ì—”ë“œ ìš”ì²­
-   **subscribeToState**: ë°±ì—”ë“œ â†’ webview ìƒíƒœ ì „ì†¡
-   **postStateToWebview**: ëª¨ë“  êµ¬ë…ìì—ê²Œ state ë¸Œë¡œë“œìºìŠ¤íŠ¸

### 9.2. ìˆœí™˜ ë©”ì‹œì§€ ë¬¸ì œ íŒ¨í„´

**ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤**:

```
1. webview: ì„¤ì • ë³€ê²½ â†’ setChatSettings()
2. webview: updateSettings gRPC ìš”ì²­
3. ë°±ì—”ë“œ: updateSettings.ts ì‹¤í–‰ â†’ ì„¤ì • ì €ì¥
4. ë°±ì—”ë“œ: postStateToWebview() í˜¸ì¶œ âš ï¸
5. ë°±ì—”ë“œ: ëª¨ë“  êµ¬ë…ìì—ê²Œ ìƒˆ state ì „ì†¡
6. webview: subscriptionìœ¼ë¡œ ìƒˆ state ë°›ìŒ
7. webview: setState() í˜¸ì¶œ â†’ UI ë®ì–´ì”Œì›€ âŒ
```

**ê²°ê³¼**: webviewê°€ ìì‹ ì´ ë³€ê²½í•œ ì„¤ì •ì„ ë‹¤ì‹œ ë°›ì•„ì„œ ì›ë˜ëŒ€ë¡œ ë˜ëŒì•„ê°

### 9.3. ìˆœí™˜ ë©”ì‹œì§€ ë°©ì§€ ì›ì¹™

#### **9.3.1. Cline ì›ë³¸ ìˆ˜ì • ì‹œ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸**

**ë©”ì‹œì§€ ì‹œìŠ¤í…œ ìˆ˜ì • ì „**:

-   [ ] ê¸°ì¡´ ë©”ì‹œì§€ í”Œë¡œìš° ì™„ì „ ì´í•´ ë° ë¬¸ì„œí™”
-   [ ] ë³€ê²½ ì‚¬í•­ì´ ë‹¤ë¥¸ êµ¬ë…ìì—ê²Œ ë¯¸ì¹˜ëŠ” ì˜í–¥ ë¶„ì„
-   [ ] `postStateToWebview()` í˜¸ì¶œ í•„ìš”ì„± ê²€í† 
-   [ ] subscription íƒ€ì´ë° ì´ìŠˆ ê°€ëŠ¥ì„± ê²€í† 
-   [ ] ìˆœí™˜ ë©”ì‹œì§€ ë°©ì§€ í…ŒìŠ¤íŠ¸ ê³„íš ìˆ˜ë¦½

**ìˆ˜ì • ì‹œ ì£¼ì˜ì‚¬í•­**:

```typescript
// âŒ ìœ„í—˜í•œ íŒ¨í„´: ëª¨ë“  ì„¤ì • ë³€ê²½ ì‹œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
async function updateSettings(settings: ChatSettings) {
	await saveSettings(settings)
	await controller.postStateToWebview() // ìˆœí™˜ ë©”ì‹œì§€ ìœ„í—˜!
}

// âœ… ì•ˆì „í•œ íŒ¨í„´: ì¡°ê±´ë¶€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
async function updateSettings(settings: ChatSettings, options?: UpdateOptions) {
	await saveSettings(settings)

	// webview ë°œì‹  ìš”ì²­ì¸ ê²½ìš° ë¸Œë¡œë“œìºìŠ¤íŠ¸ ìƒëµ
	if (!options?.skipBroadcast) {
		await controller.postStateToWebview()
	}
}
```

#### **9.3.2. webview ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„**

**íƒ€ì´ë° ê¸°ë°˜ ë³´í˜¸**:

```typescript
// webview-ui/src/context/ExtensionStateContext.tsx
const [pendingChanges, setPendingChanges] = useState<Set<string>>(new Set())

const setChatSettings = useCallback(
	(newSettings: ChatSettings) => {
		const changedKeys = getChangedKeys(chatSettings, newSettings)

		// ë³€ê²½ëœ í‚¤ë“¤ì„ ë³´í˜¸ ëª©ë¡ì— ì¶”ê°€
		setPendingChanges((prev) => new Set([...prev, ...changedKeys]))

		// ì„¤ì • ì €ì¥
		vscode.postMessage({ type: "updateSettings", settings: newSettings })

		// 1ì´ˆ í›„ ë³´í˜¸ í•´ì œ
		setTimeout(() => {
			setPendingChanges((prev) => {
				const newSet = new Set(prev)
				changedKeys.forEach((key) => newSet.delete(key))
				return newSet
			})
		}, 1000)
	},
	[chatSettings],
)

// subscriptionì—ì„œ ë³´í˜¸ëœ í‚¤ëŠ” ì—…ë°ì´íŠ¸ ë°©ì§€
useEffect(() => {
	const subscription = stateService.subscribeToState({
		onResponse: (response) => {
			const newState = response.state

			// ë³´í˜¸ëœ í‚¤ë“¤ì€ ê¸°ì¡´ ê°’ ìœ ì§€
			const protectedState = { ...newState }
			pendingChanges.forEach((key) => {
				if (key in state && key in protectedState) {
					protectedState[key] = state[key]
				}
			})

			setState(protectedState)
		},
	})
}, [pendingChanges])
```

#### **9.3.3. ë©”ì‹œì§€ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„± ì˜ë¬´í™”**

**webview â†” ë°±ì—”ë“œ ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ ê°œë°œ ì‹œ í•„ìˆ˜**:

```mermaid
sequenceDiagram
    participant W as webview
    participant G as gRPC
    participant B as Backend
    participant S as StateService

    W->>G: updateSettings(newValue)
    G->>B: updateSettings.ts
    B->>B: saveToStorage()

    Note over B: âš ï¸ ì—¬ê¸°ì„œ postStateToWebview() í˜¸ì¶œ ì‹œ ìˆœí™˜ ìœ„í—˜

    alt ìˆœí™˜ ë©”ì‹œì§€ ë°©ì§€
        B-->>S: skipBroadcast=true
    else ì¼ë°˜ì ì¸ ê²½ìš°
        B->>S: postStateToWebview()
        S->>G: broadcastState()
        G->>W: subscription.onResponse()
        W->>W: setState() âš ï¸ ë®ì–´ì”Œì›€ ìœ„í—˜
    end
```

### 9.4. ì‹¤ì œ í™˜ê²½ í…ŒìŠ¤íŠ¸ í•„ìˆ˜í™”

#### **9.4.1. Extension Host í™˜ê²½ ê²€ì¦**

**í…ŒìŠ¤íŠ¸ í™˜ê²½ vs ì‹¤ì œ í™˜ê²½**:

-   **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: ëª¨í‚¹ëœ í™˜ê²½ì—ì„œ ê°œë³„ í•¨ìˆ˜ ê²€ì¦
-   **í†µí•© í…ŒìŠ¤íŠ¸**: ì‹¤ì œ gRPC í†µì‹  í¬í•¨ ì „ì²´ í”Œë¡œìš° ê²€ì¦ â­
-   **E2E í…ŒìŠ¤íŠ¸**: ì‹¤ì œ Extension Hostì—ì„œ ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ â­

**í•„ìˆ˜ ê²€ì¦ í•­ëª©**:

```typescript
// ì‹¤ì œ í™˜ê²½ í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
describe("UI Language Setting - Real Environment", () => {
	it("should maintain language change without reverting", async () => {
		// 1. Extension Host í™˜ê²½ì—ì„œ ì‹¤í–‰
		const extensionHost = await startExtensionHost()

		// 2. ì–¸ì–´ ë³€ê²½
		await extensionHost.changeLanguage("ja")

		// 3. 1ì´ˆ ëŒ€ê¸° (subscription ë©”ì‹œì§€ ì²˜ë¦¬)
		await delay(1000)

		// 4. ì–¸ì–´ê°€ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸
		const currentLanguage = await extensionHost.getCurrentLanguage()
		expect(currentLanguage).toBe("ja")

		// 5. ì¶”ê°€ ë©”ì‹œì§€ê°€ ì–¸ì–´ë¥¼ ë˜ëŒë¦¬ì§€ ì•ŠëŠ”ì§€ í™•ì¸
		await extensionHost.triggerStateUpdate()
		await delay(500)

		const finalLanguage = await extensionHost.getCurrentLanguage()
		expect(finalLanguage).toBe("ja") // ì—¬ì „íˆ ì¼ë³¸ì–´ ìœ ì§€
	})
})
```

#### **9.4.2. ë©”ì‹œì§€ íƒ€ì´ë° ê²€ì¦**

**ë°±ì—”ë“œ ì‘ë‹µ ì†ë„ ì¸¡ì •**:

```typescript
// ì‹¤ì œ gRPC ë©”ì‹œì§€ íƒ€ì´ë° ì¸¡ì •
describe("Message Timing Analysis", () => {
	it("should measure subscription response time", async () => {
		const startTime = performance.now()

		// ì„¤ì • ë³€ê²½ ìš”ì²­
		await stateService.updateSettings(newSettings)

		// subscription ì‘ë‹µ ëŒ€ê¸°
		await waitForSubscriptionResponse()

		const responseTime = performance.now() - startTime
		console.log(`Subscription response time: ${responseTime}ms`)

		// ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ì´ ì‘ë‹µ ì†ë„ë¥¼ ë”°ë¼ì¡ì„ ìˆ˜ ìˆëŠ”ì§€ ê²€ì¦
		expect(responseTime).toBeLessThan(500) // 0.5ì´ˆ ì´ë‚´
	})
})
```

### 9.5. ê°œë°œ ë°©ë²•ë¡  ê°œì„ 

#### **9.5.1. ë¬¸ì œ ë¶„ì„ ì²´ê³„í™”**

**ë‹¨ê³„ë³„ ì ‘ê·¼ ë°©ì‹**:

1. **ì¦ìƒ ê¸°ë¡**: ì‚¬ìš©ìê°€ ë³´ê³ í•œ ë¬¸ì œ ì •í™•íˆ ê¸°ë¡
2. **ê°€ì„¤ ìˆ˜ë¦½**: ê°€ëŠ¥í•œ ì›ì¸ë“¤ì„ ì—¬ëŸ¬ ê°œ ë‚˜ì—´
3. **ê·¼ë³¸ ì›ì¸ íƒìƒ‰**: ì½”ë“œ ë ˆë²¨ì—ì„œ ì‹¤ì œ ì›ì¸ ë¶„ì„
4. **ì˜í–¥ ë²”ìœ„ íŒŒì•…**: ì—°ê´€ëœ ì‹œìŠ¤í…œë“¤ í™•ì¸
5. **í•´ê²° ë°©ì•ˆ ìš°ì„ ìˆœìœ„**: Critical â†’ High â†’ Medium ìˆœì„œ

#### **9.5.2. ë¡œê¹… í‘œì¤€ ê°•ì œ**

**Caret ë¡œê¹… ì‹œìŠ¤í…œ ì¤€ìˆ˜**:

```typescript
// âŒ ê¸ˆì§€: ì§ì ‘ console.log ì‚¬ìš©
console.log("[DEBUG] Language changed:", newLanguage)

// âœ… ê¶Œì¥: í‘œì¤€ ë¡œê±° ì‚¬ìš©
// ë°±ì—”ë“œ
import { caretLogger } from "@/utils/caret-logger"
caretLogger.debug("Language changed", { newLanguage, previousLanguage })

// í”„ë¡ íŠ¸ì—”ë“œ
import { caretWebviewLogger } from "@/caret/utils/webview-logger"
caretWebviewLogger.debug("Language changed", { newLanguage, previousLanguage })
```

**ë¡œê¹… ë ˆë²¨ ì ì ˆíˆ ì„¤ì •**:

-   **debug**: ê°œë°œ ì‹œ ìƒì„¸ ì •ë³´
-   **info**: ì¼ë°˜ì ì¸ ë™ì‘ ìƒí™©
-   **warn**: ì ì¬ì  ë¬¸ì œ ìƒí™©
-   **error**: ì‹¤ì œ ì˜¤ë¥˜ ë°œìƒ

#### **9.5.3. TDD ì›ì¹™ ê°•í™”**

**AI ì–´ì‹œìŠ¤í„´íŠ¸ TDD ì˜ë¬´í™”**:

-   [ ] êµ¬í˜„ ìš”ì²­ ì‹œ "í…ŒìŠ¤íŠ¸ë¶€í„° ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤" ì‘ë‹µ í•„ìˆ˜
-   [ ] í…ŒìŠ¤íŠ¸ ì—†ëŠ” êµ¬í˜„ ê±°ë¶€ ë° TDD ì ‘ê·¼ ì œì•ˆ í•„ìˆ˜
-   [ ] ë³µì¡í•œ ê¸°ëŠ¥ì€ ë‹¨ê³„ë³„ TDDë¡œ ë¶„í•´ í•„ìˆ˜

**Red-Green-Refactor ì‚¬ì´í´ ì¤€ìˆ˜**:

```typescript
// RED: ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì‘ì„±
it("should prevent subscription from overriding user language change", () => {
	// í…ŒìŠ¤íŠ¸ ì‘ì„± (ì•„ì§ êµ¬í˜„ ì•ˆë¨)
	expect(userLanguageChange).not.toBeOverriddenBySubscription()
})

// GREEN: ìµœì†Œí•œì˜ êµ¬í˜„ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í†µê³¼
function preventSubscriptionOverride() {
	// ìµœì†Œí•œì˜ êµ¬í˜„
	return true
}

// REFACTOR: ì½”ë“œ ê°œì„  ë° ìµœì í™”
function preventSubscriptionOverride() {
	// ì‹¤ì œ ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„
	// ì½”ë“œ ì •ë¦¬ ë° ìµœì í™”
}
```

## 11. Frontend-Backend Interaction Patterns

### 11.1. uiLanguage ì „ìš© ì—…ë°ì´íŠ¸ íŒ¨í„´ âœ¨ **ì‹¤ì œ êµ¬í˜„ë¨**

**ë¬¸ì œ**: ExtensionStateContext.tsxì—ì„œ `setChatSettings`ê°€ uiLanguageë§Œ ë³€ê²½ë˜ì–´ë„ ëª¨ë“  ì„¤ì •ì„ ë°±ì—”ë“œë¡œ ì „ì†¡í•˜ì—¬ ìˆœí™˜ ë©”ì‹œì§€ ë°œìƒ

**í•´ê²°**: ë³„ë„ì˜ `setUILanguage` í•¨ìˆ˜ ìƒì„±ìœ¼ë¡œ ë‹¨ì¼ í•„ë“œë§Œ ì—…ë°ì´íŠ¸

```typescript
// webview-ui/src/context/ExtensionStateContext.tsx
// CARET MODIFICATION: UI ì–¸ì–´ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” ë³„ë„ í•¨ìˆ˜ - chatSettings ì¶©ëŒ ë°©ì§€
setUILanguage: async (language: string) => {
    try {
        // UI ì–¸ì–´ë§Œ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì„¤ì • í¬í•¨í•˜ì§€ ì•ŠìŒ)
        await StateServiceClient.updateSettings(
            UpdateSettingsRequest.create({
                uiLanguage: language, // ì˜¤ì§ ì´ê²ƒë§Œ ì—…ë°ì´íŠ¸
            }),
        )

        // Frontend ìƒíƒœ ì—…ë°ì´íŠ¸
        setState((prevState) => ({
            ...prevState,
            uiLanguage: language,
            chatSettings: {
                ...prevState.chatSettings,
                uiLanguage: language,
            }
        }))

        console.log("[DEBUG] ğŸŒ setUILanguage completed:", language)
    } catch (error) {
        console.error("Failed to update UI language:", error)
        throw error
    }
},
```

**í•µì‹¬ ê°œì„ ì **:

-   âœ… **ë‹¨ì¼ í•„ë“œë§Œ ì „ì†¡**: `uiLanguage`ë§Œ ë°±ì—”ë“œë¡œ ì „ì†¡
-   âœ… **ìˆœí™˜ ë©”ì‹œì§€ ë°©ì§€**: ì „ì²´ ì„¤ì • ì—…ë°ì´íŠ¸ ëŒ€ì‹  ì–¸ì–´ë§Œ ì—…ë°ì´íŠ¸
-   âœ… **ì‚¬ìš©ì ê²½í—˜ ê°œì„ **: ì¦‰ì‹œ UI ë°˜ì˜, ì„¤ì • ë˜ëŒì•„ê°€ì§€ ì•ŠìŒ

**ğŸ“‹ í‘œì¤€ íŒ¨í„´ ê°€ì´ë“œ**: ìì„¸í•œ Frontend-Backend ìƒí˜¸ì‘ìš© íŒ¨í„´ì€ [Frontend-Backend ìƒí˜¸ì‘ìš© í‘œì¤€ íŒ¨í„´ ê°€ì´ë“œ](./frontend-backend-interaction-patterns.mdx)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

### 10.2. ìµœì†Œ ë°ì´í„° ì „ì†¡ ì›ì¹™

**ëª©ì **: ë¶ˆí•„ìš”í•œ ì„¤ì • ì „ì†¡ìœ¼ë¡œ ì¸í•œ ìˆœí™˜ ë©”ì‹œì§€ ë°©ì§€

**ì›ì¹™**:

1. **ë³€ê²½ ê°ì§€ ìš°ì„ **: ì‹¤ì œ ë³€ê²½ëœ í•„ë“œë§Œ ì‹ë³„
2. **ì„ íƒì  ì „ì†¡**: ë³€ê²½ëœ ì„¤ì •ë§Œ ë°±ì—”ë“œë¡œ ì „ì†¡
3. **ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸**: ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•œ optimistic update
4. **ì˜¤ë¥˜ ì‹œ ë¡¤ë°±**: ë°±ì—”ë“œ ì‹¤íŒ¨ ì‹œ UI ìƒíƒœ ë³µì›

**ì ìš© ëŒ€ìƒ**:

-   uiLanguage ë³€ê²½
-   chatSettings ê°œë³„ í•„ë“œ ë³€ê²½
-   apiConfiguration ë¶€ë¶„ ì—…ë°ì´íŠ¸
-   ê¸°íƒ€ ì„¤ì • ë³€ê²½

## 12. Circular Message Prevention

### 12.1. ìˆœí™˜ ë©”ì‹œì§€ ë°œìƒ ë©”ì»¤ë‹ˆì¦˜

**ì¼ë°˜ì ì¸ ìˆœí™˜ ë©”ì‹œì§€ íŒ¨í„´**:

```
1. webview: ì„¤ì • ë³€ê²½ â†’ setChatSettings({uiLanguage: "ja"})
2. webview: updateSettings gRPC ìš”ì²­ (ëª¨ë“  ì„¤ì • í¬í•¨)
3. ë°±ì—”ë“œ: updateSettings.ts ì‹¤í–‰
   - ëª¨ë“  ì„¤ì •ì„ ì—…ë°ì´íŠ¸ë¡œ ì¸ì‹
   - Line 86: await controller.postStateToWebview() í˜¸ì¶œ
4. ë°±ì—”ë“œ: sendStateUpdate() â†’ ëª¨ë“  êµ¬ë…ìì—ê²Œ ìƒˆ state ì „ì†¡
5. webview: subscription onResponse ë°›ìŒ â†’ setState() í˜¸ì¶œ
6. ê²°ê³¼: ë°±ì—”ë“œê°€ ë³´ë‚¸ stateë¡œ UI ë®ì–´ì”Œì›Œì§ âŒ
```

### 11.2. ë°©ì§€ ì „ëµ

#### **11.2.1. Frontend ë‹¨ê³„ ë°©ì§€**

```typescript
// ë³€ê²½ ê°ì§€ë¡œ ìµœì†Œ ë°ì´í„°ë§Œ ì „ì†¡
const isLanguageOnlyChange = detectLanguageOnlyChange(previous, current)
if (isLanguageOnlyChange) {
	// ì–¸ì–´ë§Œ ì „ì†¡ (ë‹¤ë¥¸ ì„¤ì • ì œì™¸)
	await StateServiceClient.updateSettings({
		chatSettings: newChatSettings,
		// apiConfiguration, telemetrySetting ë“± ì œì™¸
	})
}
```

#### **11.2.2. Backend ë‹¨ê³„ ë°©ì§€**

```typescript
// src/core/controller/state/updateSettings.ts
export async function updateSettings(request: UpdateSettingsRequest): Promise<Empty> {
	// ì„¤ì • ì €ì¥
	if (request.chatSettings) {
		await saveSettings(request.chatSettings)
	}

	// uiLanguageë§Œ ë³€ê²½ëœ ê²½ìš° ë¸Œë¡œë“œìºìŠ¤íŠ¸ ìŠ¤í‚µ
	const isLanguageOnlyUpdate = request.chatSettings && !request.apiConfiguration && !request.telemetrySetting

	if (!isLanguageOnlyUpdate) {
		// ì „ì²´ ì„¤ì • ë³€ê²½ ì‹œì—ë§Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
		await controller.postStateToWebview()
	}

	return Empty.create()
}
```

### 11.3. ê°œë°œ ì²´í¬ë¦¬ìŠ¤íŠ¸

**webview â†” ë°±ì—”ë“œ ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ ê°œë°œ ì‹œ í•„ìˆ˜ í™•ì¸ì‚¬í•­**:

-   [ ] **ë³€ê²½ ê°ì§€**: ì‹¤ì œ ë³€ê²½ëœ í•„ë“œë§Œ ì‹ë³„í•˜ëŠ”ê°€?
-   [ ] **ìµœì†Œ ì „ì†¡**: ë³€ê²½ë˜ì§€ ì•Šì€ ì„¤ì •ë„ í•¨ê»˜ ì „ì†¡í•˜ê³  ìˆì§€ ì•Šì€ê°€?
-   [ ] **ë¸Œë¡œë“œìºìŠ¤íŠ¸ í•„ìš”ì„±**: ë°±ì—”ë“œì—ì„œ postStateToWebview() í˜¸ì¶œì´ í•„ìš”í•œê°€?
-   [ ] **subscription ë³´í˜¸**: webviewì—ì„œ ìì‹ ì´ ë³€ê²½í•œ ê°’ì´ ë®ì–´ì”Œì›Œì§€ì§€ ì•ŠëŠ”ê°€?
-   [ ] **íƒ€ì´ë° ê²€ì¦**: ì‹¤ì œ Extension Host í™˜ê²½ì—ì„œ ìˆœí™˜ì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ê°€?

### 11.4. ë©”ì‹œì§€ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ ì˜ë¬´í™”

**ëª¨ë“  webview â†” ë°±ì—”ë“œ ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ì€ ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„± í•„ìˆ˜**:

```mermaid
sequenceDiagram
    participant W as webview
    participant G as gRPC
    participant B as Backend
    participant S as StateService

    Note over W: ì‚¬ìš©ìê°€ ì–¸ì–´ë¥¼ ì¼ë³¸ì–´ë¡œ ë³€ê²½

    W->>W: detectLanguageOnlyChange() = true
    W->>G: updateSettings(chatSettings only)
    G->>B: updateSettings.ts
    B->>B: saveToStorage(chatSettings)

    Note over B: isLanguageOnlyUpdate = true
    Note over B: postStateToWebview() ìŠ¤í‚µ âœ…

    B->>G: Empty response
    G->>W: Success

    Note over W: UI ì–¸ì–´ê°€ ì¼ë³¸ì–´ë¡œ ìœ ì§€ë¨ âœ…
```

---

**ì´ ì„¹ì…˜ì˜ ëª©ì **:

-   Clineì˜ ë³µì¡í•œ ë©”ì‹œì§€ ì‹œìŠ¤í…œì—ì„œ ìˆœí™˜ ë©”ì‹œì§€ ë¬¸ì œ ë°©ì§€
-   ì‹¤ì œ Extension Host í™˜ê²½ì—ì„œì˜ ê²€ì¦ ì˜ë¬´í™”
-   ì²´ê³„ì ì¸ ë¬¸ì œ ë¶„ì„ ë° í•´ê²° ë°©ë²•ë¡  í™•ë¦½
-   ì¬ë°œ ë°©ì§€ë¥¼ ìœ„í•œ ê°œë°œ í”„ë¡œì„¸ìŠ¤ ê°œì„ 

</file_content>

Now that you have the latest state of the file, try the operation again with fewer, more precise SEARCH blocks. For large files especially, it may be prudent to try to limit yourself to <5 SEARCH/REPLACE blocks at a time, then wait for the user to respond with the result of the operation before following up with another replace_in_file call to make additional edits.
(If you run into this error 3 times in a row, you may use the write_to_file tool as a fallback.)

</error><environment_details>
# VSCode Visible Files
caret-docs/development/caret-architecture-and-implementation-guide.mdx

# VSCode Open Tabs

caret-docs/development/caret-architecture-and-implementation-guide.mdx

# Current Time

2025. 6.  24. ì˜¤í›„ 8:04:50 (Asia/Seoul, UTC+9:00)

# Context Window Usage

242,993 / 1,048.576K tokens used (23%)

# Current Mode

ACT MODE
</environment_details>
