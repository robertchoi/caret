# 024: Caret 모드 토큰 효율성 개선 분석 및 최적화

**업무 번호**: 024  
**상태**: ✅ **완료** (2025-07-18)
**업무 명**: Caret JSON 시스템의 실제 토큰 효율성 개선이 체감되지 않는 문제 분석 및 해결  
**우선순위**: 🔥 **HIGH** (토큰 비용 절약 효과 직결)  
**예상 소요 시간**: 3-4시간  
**단일 세션 완료 가능**: ✅ Yes  

## 📋 **업무 개요**

테스트 환경에서는 Caret의 JSON 기반 시스템 프롬프트가 Cline 대비 58%의 토큰 절약 효과를 보였으나, 실제 사용 환경에서는 그 효과가 체감되지 않는 문제가 발생했습니다. 이 업무의 목표는 실제 데이터 기반의 심층 분석을 통해 원인을 규명하고, 향후 최적화 방향을 제시하는 것입니다.

## 🎯 **업무 목표**

1.  **실제 환경 토큰 사용량 심층 분석**: 고도화된 통계 분석을 통해 테스트 환경과 실제 환경의 차이를 명확히 규명합니다.
2.  **데이터 기반 원인 분석**: 'API 호출당 효율성', '이상치' 등 다각적인 관점에서 성능 저하의 근본 원인을 분석합니다.
3.  **향후 최적화 방향 제시**: 분석 결과를 바탕으로 '동적 도구 로딩 시스템' 등 구체적인 해결 방안의 필요성을 데이터로 증명합니다.

## 🛠️ **분석 및 해결 과정**

### **Phase 1: 성능 비교 실험 및 보고서 시스템 고도화**

단순 평균 비교만으로는 실제 성능을 파악하기 어렵다는 문제점에서 출발하여, 다음과 같이 보고서 생성 스크립트(`generate-comprehensive-report.js`)를 점진적으로 고도화했습니다.

1.  **API 호출당 효율성 분석**: 모든 지표를 '실험당'이 아닌 **'API 호출당'** 기준으로 변경하여, 호출 1회당 순수 효율성을 비교할 수 있도록 개선했습니다.
2.  **통계적 분석 강화**: **중앙값(Median)**과 **표준편차(σ)**를 도입하여, 평균값만으로는 알 수 없는 데이터의 분포와 안정성을 파악했습니다.
3.  **그룹 기반 이상치 분석**: '같은 과업, 같은 모델' 등 동일 조건 그룹 내에서만 이상치를 탐지하도록 로직을 개선하여 분석의 정확도를 높였습니다.
4.  **조건부 비교 및 이상치 제외 분석**: **'Pro 모델 한정'**, **'이상치 제외'** 등 다양한 조건으로 데이터를 필터링하고 분석하는 기능을 추가하여, 특정 요인이 전체 결과에 미치는 영향을 심층적으로 파악할 수 있도록 했습니다.

### **Phase 2: 최종 보고서 기반 심층 분석**

고도화된 보고서 시스템을 통해 얻은 최종 분석 결과는 다음과 같습니다.

- **[최종 보고서 링크]**: `caret-docs\reports\experiment\json_caret_performance_test_20250713\comprehensive-performance-report-20250717.md`

## 🎯 **최종 분석 결론**

1.  **API 호출당 효율성은 Caret 우세**: 이상치를 포함한 전체 데이터 및 Pro 모델 한정 데이터 모두에서, Caret은 Cline 대비 **API 호출 1회당 비용, 시간, 토큰 사용량 면에서 더 효율적**인 것으로 나타났습니다. 이는 Caret의 JSON 기반 프롬프트 시스템이 이론적으로 우수함을 증명합니다.

2.  **Caret의 불안정한 성능 (높은 표준편차)**: 하지만 여러 지표에서 Caret의 **표준편차(σ)가 Cline보다 높게** 나타났습니다. 이는 Caret의 성능이 Cline보다 더 변동성이 크고, 특정 상황에서 성능이 크게 저하되는 '어려운 케이스(이상치)'가 더 많음을 시사합니다.

3.  **이상치의 영향**: '이상치 분석' 섹션을 통해, 특정 과업(주로 `json-processor`)에서 Caret이 비정상적으로 높은 비용과 시간을 소모하는 케이스가 있음을 확인했습니다. 이러한 소수의 이상치들이 전체 평균을 끌어올려, '전체 성능 요약'에서는 오히려 Cline의 실행 속도가 더 빠른 것처럼 보이는 왜곡을 유발했습니다.

4.  **가설 입증**: "Caret의 평균 속도 저하는 소수의 이상치 때문일 것이다"라는 가설은 **'이상치 제외 분석'을 통해 사실로 증명**되었습니다. 이상치를 제거하자 Caret과 Cline의 성능 격차는 크게 줄어들거나 역전되어, 두 에이전트의 본질적인 성능은 유사함을 확인할 수 있었습니다.

5.  **근본 원인**: 이러한 성능 불안정성과 이상치 발생의 근본 원인은 현재 시스템이 컨텍스트에 상관없이 **모든 도구를 시스템 프롬프트에 포함**하기 때문으로 추정됩니다. 복잡한 과업에서 불필요한 도구 정보가 오히려 AI의 판단을 방해하여 비효율적인 API 호출을 유발하는 것입니다.

## 🚀 **향후 조치**

본 분석을 통해, Caret의 토큰 효율성과 성능 안정성을 극대화하기 위한 다음 단계 과제가 명확해졌습니다.

- **동적 도구 로딩 시스템 구현**: 현재 작업 컨텍스트에 필요한 도구만 선택적으로 프롬프트에 포함시키는 시스템을 구현하여, 불필요한 토큰 낭비와 AI의 혼란을 근본적으로 해결해야 합니다. (Phase 2 목표)

## 🔄 **검증 체크리스트**

### **✅ 분석 및 보고 완료 체크리스트**
- [x] 잘못된 위치의 실험 파일 정리 완료
- [x] 보고서 생성 스크립트의 분석 로직 오류 수정 완료
- [x] API 호출당 효율성 분석 기능 추가 완료
- [x] 중앙값, 표준편차 등 통계 분석 기능 추가 완료
- [x] 그룹별 이상치 탐지 기능 추가 완료
- [x] 이상치 제외 분석 기능 추가 완료
- [x] Pro 모델 한정 비교 분석 기능 추가 완료
- [x] 최종 보고서 생성 및 검토 완료
- [x] 실험 설계 문서(`experiment-design.md`)에 최종 분석 방법론 반영 완료

## 📝 **업무 진행 로그**

### **2025-01-27 (월) - 초기 분석 및 측정 시스템 구축**
- `system-prompt-token-measurement.js` 등 초기 측정 도구를 개발하여 테스트 환경에서의 토큰 효율성(58% 절약)을 측정함.
- 실제 환경과의 차이점을 인지하고, 동적 로딩 시스템의 필요성을 처음으로 제기함.

### **2025-07-18 (금) - 심층 분석 및 최종 결론 도출**
- **실험 데이터 정리**: `json-processor` 관련 파일을 올바른 위치로 이동.
- **보고서 시스템 고도화**: 단순 평균 비교 방식의 한계를 극복하기 위해, 피드백을 반복적으로 반영하여 보고서 생성 스크립트를 대폭 개선함.
  - **API 호출당 효율성 분석**으로 전환하여 직접적인 성능 비교가 가능해짐.
  - **중앙값, 표준편차**를 도입하여 데이터 분포와 안정성 파악.
  - **그룹별 이상치 탐지** 로직으로 분석 정확도 향상.
  - **이상치 제외 분석**, **Pro 모델 한정 분석** 등 다각적인 분석 기능 추가.
- **최종 분석 및 결론**: 고도화된 보고서를 통해 "Caret의 성능 저하는 소수의 이상치 때문"이라는 핵심 가설을 데이터로 증명하고, 근본 원인과 향후 해결 과제를 명확히 함.
